{% schema %}
{
  "name": "AI Sales Assistant",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable AI Assistant",
      "default": true
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        { "value": "bottom-right", "label": "Bottom Right" },
        { "value": "bottom-left", "label": "Bottom Left" },
        { "value": "top-right", "label": "Top Right" },
        { "value": "top-left", "label": "Top Left" },
        { "value": "center-right", "label": "Center Right" },
        { "value": "center-left", "label": "Center Left" }
      ],
      "default": "bottom-right"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#ee5cee"
    },
    {
      "type": "select",
      "id": "interface_language",
      "label": "Interface Language",
      "info": "Language for chatbot UI. AI responses auto-detect customer language.",
      "options": [
        { "value": "en", "label": "English" },
        { "value": "es", "label": "Español" },
        { "value": "fr", "label": "Français" },
        { "value": "de", "label": "Deutsch" },
        { "value": "ja", "label": "日本語" },
        { "value": "it", "label": "Italiano" },
        { "value": "pt", "label": "Português" },
        { "value": "zh", "label": "中文" }
      ],
      "default": "en"
    },
    {
      "type": "textarea",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Hello! I'm your AI sales assistant. I can help you find products, answer questions, and provide personalized recommendations."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Launcher Button Text",
      "default": "Ask AI Assistant"
    },
    {
      "type": "header",
      "content": "Welcome Popup"
    },
    {
      "type": "checkbox",
      "id": "welcome_popup_enabled",
      "label": "Enable Welcome Popup",
      "default": true,
      "info": "Shows a greeting popup 3 seconds after page load"
    },
    {
      "type": "header",
      "content": "Product Discovery Buttons"
    },
    {
      "type": "checkbox",
      "id": "best_sellers_visible",
      "label": "Show Best Sellers",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "new_arrivals_visible",
      "label": "Show New Arrivals",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "on_sale_visible",
      "label": "Show On Sale",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "recommendations_visible",
      "label": "Show Recommendations",
      "default": true
    },
    {
      "type": "header",
      "content": "Customer Support Buttons"
    },
    {
      "type": "checkbox",
      "id": "shipping_visible",
      "label": "Show Shipping",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "returns_visible",
      "label": "Show Returns",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "track_order_visible",
      "label": "Show Track Order",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "help_visible",
      "label": "Show Help",
      "default": true
    }
  ]
}
{% endschema %}

<!-- Only render if enabled -->
{% if block.settings.enabled %}

<!-- 1. Render container -->
<div id="ai-sales-assistant-container"></div>

<!-- 2. Expose settings to JavaScript -->
<script>
  window.aiSalesAssistantSettings = {
    enabled: {{ block.settings.enabled | default: true | json }},
    position: {{ block.settings.position | default: "bottom-right" | json }},
    buttonText: {{ block.settings.button_text | default: "Ask AI Assistant" | json }},
    chatTitle: "AI Sales Assistant",
    statusText: "Online",
    closeButtonLabel: "Close",
    welcomeMessage: {{ block.settings.welcome_message | default: "Hello! I'm your AI sales assistant. How can I help you today?" | json }},
    inputPlaceholder: null,
    primaryColor: {{ block.settings.primary_color | default: "#ee5cee" | json }},
    interfaceLanguage: {{ block.settings.interface_language | default: "en" | json }},

    // Welcome popup settings
    welcomePopupEnabled: {{ block.settings.welcome_popup_enabled | default: true | json }},
    welcomePopupMessage: null,

    // Quick button visibility - controlled from Theme Editor
    // Note: Don't use | default filter here as it treats false as falsy
    bestSellersVisible: {{ block.settings.best_sellers_visible | json }},
    newArrivalsVisible: {{ block.settings.new_arrivals_visible | json }},
    onSaleVisible: {{ block.settings.on_sale_visible | json }},
    recommendationsVisible: {{ block.settings.recommendations_visible | json }},
    shippingVisible: {{ block.settings.shipping_visible | json }},
    returnsVisible: {{ block.settings.returns_visible | json }},
    trackOrderVisible: {{ block.settings.track_order_visible | json }},
    helpVisible: {{ block.settings.help_visible | json }},

    // Shop data
    shopDomain: {{ shop.permanent_domain | json }},
    currency: {{ shop.currency | json }}
  };

  // Inline visibility handler - runs after widget loads to hide/show buttons
  (function() {
    const settings = window.aiSalesAssistantSettings;

    // Map button prompts to visibility settings
    const buttonVisibilityMap = {
      'bestSellersPrompt': settings.bestSellersVisible,
      'newArrivalsPrompt': settings.newArrivalsVisible,
      'onSalePrompt': settings.onSaleVisible,
      'recommendedPrompt': settings.recommendationsVisible,
      'shippingPrompt': settings.shippingVisible,
      'returnsPrompt': settings.returnsVisible,
      'trackOrderPrompt': settings.trackOrderVisible,
      'I need help with something': settings.helpVisible
    };

    function applyVisibility() {
      const buttons = document.querySelectorAll('.quick-action-btn');
      buttons.forEach(btn => {
        const prompt = btn.getAttribute('data-prompt');
        // Check each visibility setting
        let shouldHide = false;

        if (prompt && prompt.includes('popular') && settings.bestSellersVisible === false) shouldHide = true;
        if (prompt && prompt.includes('new arrivals') && settings.newArrivalsVisible === false) shouldHide = true;
        if (prompt && prompt.includes('sale') && settings.onSaleVisible === false) shouldHide = true;
        if (prompt && prompt.includes('recommendation') && settings.recommendationsVisible === false) shouldHide = true;
        if (prompt && prompt.includes('shipping') && settings.shippingVisible === false) shouldHide = true;
        if (prompt && prompt.includes('return') && settings.returnsVisible === false) shouldHide = true;
        if (prompt && prompt.includes('track') && settings.trackOrderVisible === false) shouldHide = true;
        if (prompt && prompt.includes('help') && settings.helpVisible === false) shouldHide = true;

        if (shouldHide) {
          btn.style.display = 'none';
        }
      });

      // Hide section labels if all buttons in section are hidden
      document.querySelectorAll('.quick-actions-section').forEach(section => {
        const visibleButtons = section.querySelectorAll('.quick-action-btn:not([style*="display: none"])');
        if (visibleButtons.length === 0) {
          section.style.display = 'none';
        }
      });
    }

    // Run when DOM is ready and again after a delay (for dynamic content)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(applyVisibility, 500);
        setTimeout(applyVisibility, 1500);
      });
    } else {
      setTimeout(applyVisibility, 500);
      setTimeout(applyVisibility, 1500);
    }

    // Also observe for dynamic changes
    const observer = new MutationObserver(() => {
      applyVisibility();
    });

    setTimeout(() => {
      const container = document.getElementById('ai-sales-assistant-container');
      if (container) {
        observer.observe(container, { childList: true, subtree: true });
      }
    }, 100);
  })();
</script>

<!-- 3. Load widget assets from Vercel (production) -->
<link rel="stylesheet" href="https://shopibot.vercel.app/widget.css">
<script src="https://shopibot.vercel.app/widget.js" defer></script>

{% endif %}
