{% comment %}
AI Sales Assistant Widget Block
This creates a floating chat widget that can be added to any page
{% endcomment %}

{% schema %}
{
  "name": "AI Sales Assistant",
  "target": "body",
  "stylesheet": "ai-sales-assistant.css",
  "javascript": "ai-sales-assistant.js",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable AI Assistant",
      "default": true
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "top-right",
          "label": "Top Right"
        },
        {
          "value": "top-left",
          "label": "Top Left"
        },
        {
          "value": "center-right",
          "label": "Center Right"
        },
        {
          "value": "center-left",
          "label": "Center Left"
        }
      ],
      "default": "bottom-right"
    },
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Ask AI Assistant"
    },
    {
      "type": "text",
      "id": "chat_title",
      "label": "Chat Title",
      "default": "AI Sales Assistant"
    },
    {
      "type": "text",
      "id": "status_text",
      "label": "Status Text",
      "default": "Online"
    },
    {
      "type": "text",
      "id": "close_button_label",
      "label": "Close Button Label",
      "default": "Close"
    },
    {
      "type": "textarea",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Hello! I'm your AI sales assistant. I can help you find products, answer questions, and provide personalized recommendations."
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input Placeholder",
      "default": "Ask me anything about our products..."
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#ee5cee"
    },
    {
      "type": "header",
      "content": "Welcome Screen - Quick Actions"
    },
    {
      "type": "text",
      "id": "section_discovery_label",
      "label": "Product Discovery Section Label",
      "default": "Product Discovery"
    },
    {
      "type": "text",
      "id": "best_sellers_text",
      "label": "Best Sellers Button",
      "default": "Best Sellers"
    },
    {
      "type": "text",
      "id": "new_arrivals_text",
      "label": "New Arrivals Button",
      "default": "New Arrivals"
    },
    {
      "type": "text",
      "id": "on_sale_text",
      "label": "On Sale Button",
      "default": "On Sale"
    },
    {
      "type": "text",
      "id": "recommendations_text",
      "label": "Recommendations Button",
      "default": "For You"
    },
    {
      "type": "header",
      "content": "Welcome Screen - Support Actions"
    },
    {
      "type": "text",
      "id": "section_support_label",
      "label": "Support Section Label",
      "default": "Customer Support"
    },
    {
      "type": "text",
      "id": "shipping_text",
      "label": "Shipping Button",
      "default": "Shipping Info"
    },
    {
      "type": "text",
      "id": "returns_text",
      "label": "Returns Button",
      "default": "Returns"
    },
    {
      "type": "text",
      "id": "track_order_text",
      "label": "Track Order Button",
      "default": "Track Order"
    },
    {
      "type": "text",
      "id": "help_text",
      "label": "Help Button",
      "default": "Help & FAQ"
    }
  ]
}
{% endschema %}

<!-- AI Sales Assistant Widget will be dynamically loaded -->
<div id="ai-sales-assistant-container"></div>

<script>
// AI Sales Assistant Widget JavaScript
(function() {
  let chatOpen = false;
  let conversationHistory = [];
  let widgetSettings = null;
  let currentQuickReplies = []; // ‚ú® NEW: Track current quick replies
  let currentSentiment = 'neutral'; // ‚ú® NEW: Track sentiment for styling
  let currentSuggestedActions = []; // ‚ú® NEW: Track suggested actions

  // ‚úÖ XSS PROTECTION: Helper function to escape HTML entities
  // This provides defense-in-depth protection even for admin-controlled settings
  function escapeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Sanitize color values to prevent CSS injection
  function sanitizeColor(color) {
    if (!color) return '#ee5cee'; // default color
    // Only allow hex colors (#RGB or #RRGGBB)
    if (/^#([0-9A-Fa-f]{3}){1,2}$/.test(color)) {
      return color;
    }
    return '#ee5cee'; // fallback to default if invalid
  }

  // ‚úÖ SECURITY: Sanitize URLs to prevent XSS attacks
  function sanitizeUrl(url) {
    if (!url) return '';
    const urlStr = String(url).trim();

    // Block dangerous protocols
    const dangerousProtocols = /^(javascript|data|vbscript|file|about):/i;
    if (dangerousProtocols.test(urlStr)) {
      console.warn('‚ö†Ô∏è Blocked dangerous URL protocol:', urlStr);
      return '';
    }

    // Allow only http, https, or relative URLs
    if (urlStr.startsWith('http://') || urlStr.startsWith('https://') || urlStr.startsWith('/')) {
      return urlStr;
    }

    // If it doesn't start with a protocol, treat as relative
    if (!urlStr.includes(':')) {
      return urlStr;
    }

    console.warn('‚ö†Ô∏è Blocked suspicious URL:', urlStr);
    return '';
  }

  // ‚úÖ PERFORMANCE: Retry with exponential backoff
  async function fetchWithRetry(url, options = {}, maxRetries = 3) {
    let lastError;

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        const response = await fetch(url, options);
        if (response.ok) {
          return response;
        }

        // Don't retry on client errors (4xx), only server errors (5xx)
        if (response.status >= 400 && response.status < 500) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        lastError = new Error(`Request failed with status ${response.status}`);
      } catch (error) {
        lastError = error;

        // Don't retry on last attempt
        if (attempt === maxRetries) break;

        // Exponential backoff: 1s, 2s, 4s
        const delay = Math.pow(2, attempt) * 1000;
        console.log(`‚è≥ Retry attempt ${attempt + 1}/${maxRetries} after ${delay}ms`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }

    throw lastError;
  }

  // ‚úÖ FEATURE: Load conversation from localStorage
  function loadConversationHistory() {
    try {
      const stored = localStorage.getItem('ai_chat_history');
      if (stored) {
        const parsed = JSON.parse(stored);
        // Only load if recent (within 24 hours)
        if (parsed.timestamp && (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000)) {
          conversationHistory = parsed.messages || [];
          console.log('üì• Loaded conversation history:', conversationHistory.length, 'messages');
          return true;
        }
      }
    } catch (e) {
      console.error('Failed to load conversation history:', e);
    }
    return false;
  }

  // ‚úÖ FEATURE: Save conversation to localStorage
  function saveConversationHistory() {
    try {
      localStorage.setItem('ai_chat_history', JSON.stringify({
        messages: conversationHistory,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Failed to save conversation history:', e);
    }
  }

  // ‚úÖ MEMORY: Cleanup function for widget
  let settingsCheckInterval = null;
  function cleanupWidget() {
    // Clear interval
    if (settingsCheckInterval) {
      clearInterval(settingsCheckInterval);
      settingsCheckInterval = null;
    }

    // Remove event listeners
    if (window.aiWidgetHandlers) {
      const toggleBtn = document.getElementById('ai-chat-toggle-btn');
      const closeBtn = document.getElementById('ai-chat-close-btn');
      const sendBtn = document.getElementById('ai-chat-send-btn');
      const inputField = document.getElementById('ai-chat-input-field');

      if (toggleBtn && window.aiWidgetHandlers.toggleHandler) {
        toggleBtn.removeEventListener('click', window.aiWidgetHandlers.toggleHandler);
      }
      if (closeBtn && window.aiWidgetHandlers.closeHandler) {
        closeBtn.removeEventListener('click', window.aiWidgetHandlers.closeHandler);
      }
      if (sendBtn && window.aiWidgetHandlers.sendHandler) {
        sendBtn.removeEventListener('click', window.aiWidgetHandlers.sendHandler);
      }
      if (inputField && window.aiWidgetHandlers.keyHandler) {
        inputField.removeEventListener('keypress', window.aiWidgetHandlers.keyHandler);
      }
      if (window.aiWidgetHandlers.escapeHandler) {
        document.removeEventListener('keydown', window.aiWidgetHandlers.escapeHandler);
      }
      if (window.aiWidgetHandlers.focusTrapHandler) {
        document.removeEventListener('keydown', window.aiWidgetHandlers.focusTrapHandler);
      }
      if (window.aiWidgetHandlers.outsideClickHandler) {
        document.removeEventListener('click', window.aiWidgetHandlers.outsideClickHandler);
      }
    }

    console.log('üßπ Widget cleanup complete');
  }

  // Expose cleanup for testing
  window.cleanupAIWidget = cleanupWidget;

  // üìä ANALYTICS: Integration hooks
  const analyticsEvents = {
    WIDGET_OPENED: 'ai_widget_opened',
    WIDGET_CLOSED: 'ai_widget_closed',
    MESSAGE_SENT: 'ai_message_sent',
    MESSAGE_RECEIVED: 'ai_message_received',
    PRODUCT_CLICKED: 'ai_product_clicked',
    SUGGESTION_CLICKED: 'ai_suggestion_clicked',
    ERROR_OCCURRED: 'ai_error_occurred'
  };

  function trackAnalytics(eventName, data = {}) {
    // Trigger custom event for external analytics systems
    const event = new CustomEvent('ai-widget-analytics', {
      detail: {
        event: eventName,
        timestamp: new Date().toISOString(),
        ...data
      }
    });
    window.dispatchEvent(event);

    // Google Analytics (if available)
    if (typeof gtag === 'function') {
      gtag('event', eventName, data);
    }

    // Google Tag Manager (if available)
    if (typeof dataLayer !== 'undefined') {
      dataLayer.push({
        event: eventName,
        ...data
      });
    }

    // Meta Pixel (if available)
    if (typeof fbq === 'function') {
      fbq('trackCustom', eventName, data);
    }

    console.log('üìä Analytics:', eventName, data);
  }

  // Expose analytics for custom integrations
  window.aiWidgetAnalytics = trackAnalytics;

  // üåê OFFLINE SUPPORT: Message queue
  let messageQueue = [];
  let isOnline = navigator.onLine;

  // Load queued messages from localStorage
  function loadMessageQueue() {
    try {
      const stored = localStorage.getItem('ai_message_queue');
      if (stored) {
        messageQueue = JSON.parse(stored);
        console.log('üì• Loaded message queue:', messageQueue.length, 'messages');
      }
    } catch (e) {
      console.error('Failed to load message queue:', e);
    }
  }

  // Save message queue to localStorage
  function saveMessageQueue() {
    try {
      localStorage.setItem('ai_message_queue', JSON.stringify(messageQueue));
    } catch (e) {
      console.error('Failed to save message queue:', e);
    }
  }

  // Process queued messages when back online
  function processMessageQueue() {
    if (!isOnline || messageQueue.length === 0) return;

    console.log('üì§ Processing queued messages:', messageQueue.length);

    const queue = [...messageQueue];
    messageQueue = [];
    saveMessageQueue();

    queue.forEach(queuedMessage => {
      // Add queued indicator
      addMessageToChat('user', `${queuedMessage.message} üì§`);

      // Attempt to send
      setTimeout(() => {
        sendMessageToServer(queuedMessage.message);
      }, 500);
    });
  }

  // Monitor online/offline status
  window.addEventListener('online', () => {
    isOnline = true;
    console.log('üåê Back online');
    showNotification('Back online! Sending queued messages...', 'success');
    processMessageQueue();
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    console.log('üì° Offline mode activated');
    showNotification('You\'re offline. Messages will be queued.', 'info');
  });

  // Load queue on init
  loadMessageQueue();

  // ‚ú® NEW: Apply sentiment-based styling to chat widget
  function applySentimentStyling(sentiment) {
    const chatWidget = document.getElementById('ai-chat-widget');
    const chatHeader = document.querySelector('.ai-chat-header');
    const messagesContainer = document.getElementById('ai-chat-messages');

    if (!chatWidget) return;

    // Define sentiment color schemes (subtle variations)
    const sentimentStyles = {
      positive: {
        headerGradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', // Bright green
        headerShadow: '0 4px 12px rgba(16, 185, 129, 0.3)',
        messagesBg: '#f0fdf4', // Light green tint
        accentColor: '#10b981'
      },
      negative: {
        headerGradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', // Warm orange
        headerShadow: '0 4px 12px rgba(245, 158, 11, 0.3)',
        messagesBg: '#fffbeb', // Light warm tint
        accentColor: '#f59e0b'
      },
      neutral: {
        headerGradient: `linear-gradient(135deg, ${widgetSettings?.primaryColor || '#ee5cee'} 0%, ${adjustColor(widgetSettings?.primaryColor || '#ee5cee', -20)} 100%)`,
        headerShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
        messagesBg: '#ffffff',
        accentColor: widgetSettings?.primaryColor || '#ee5cee'
      }
    };

    const style = sentimentStyles[sentiment] || sentimentStyles.neutral;

    // Apply styling with smooth transitions
    if (chatHeader) {
      chatHeader.style.transition = 'all 0.5s ease';
      chatHeader.style.background = style.headerGradient;
      chatHeader.style.boxShadow = style.headerShadow;
    }

    if (messagesContainer) {
      messagesContainer.style.transition = 'background-color 0.5s ease';
      messagesContainer.style.backgroundColor = style.messagesBg;
    }

    // Update quick reply buttons color
    const quickReplyButtons = document.querySelectorAll('.quick-reply-btn');
    quickReplyButtons.forEach(btn => {
      btn.style.transition = 'all 0.3s ease';
      btn.style.borderColor = style.accentColor;
      btn.style.color = style.accentColor;
    });
  }

  // Helper function to adjust color brightness
  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
      (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
      (B < 255 ? B < 1 ? 0 : B : 255))
      .toString(16).slice(1);
  }

  // Get settings from block settings or fetch from API
  const blockSettings = {
    enabled: {{ block.settings.enabled | json }},
    position: {{ block.settings.position | json }},
    buttonText: {{ block.settings.button_text | json }},
    chatTitle: {{ block.settings.chat_title | json }},
    statusText: {{ block.settings.status_text | json }},
    closeButtonLabel: {{ block.settings.close_button_label | json }},
    welcomeMessage: {{ block.settings.welcome_message | json }},
    inputPlaceholder: {{ block.settings.input_placeholder | json }},
    primaryColor: {{ block.settings.primary_color | json }},
    sectionDiscoveryLabel: {{ block.settings.section_discovery_label | json }},
    bestSellersText: {{ block.settings.best_sellers_text | json }},
    newArrivalsText: {{ block.settings.new_arrivals_text | json }},
    onSaleText: {{ block.settings.on_sale_text | json }},
    recommendationsText: {{ block.settings.recommendations_text | json }},
    sectionSupportLabel: {{ block.settings.section_support_label | json }},
    shippingText: {{ block.settings.shipping_text | json }},
    returnsText: {{ block.settings.returns_text | json }},
    trackOrderText: {{ block.settings.track_order_text | json }},
    helpText: {{ block.settings.help_text | json }}
  };
  
  // Toggle chat window
  window.toggleAIChat = function() {
    console.log('üîÑ AI Widget: toggleAIChat called, current state:', chatOpen);
    const chatWindow = document.getElementById('ai-chat-window');
    const toggleBtn = document.getElementById('ai-chat-toggle-btn');

    if (!chatWindow) {
      console.error('‚ùå AI Widget: Chat window not found!');
      return;
    }

    chatOpen = !chatOpen;

    // üìä ANALYTICS: Track open/close
    trackAnalytics(chatOpen ? analyticsEvents.WIDGET_OPENED : analyticsEvents.WIDGET_CLOSED, {
      timestamp: new Date().toISOString(),
      conversationLength: conversationHistory.length
    });

    // ‚ú® ACCESSIBILITY: Update aria-expanded attribute
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', chatOpen.toString());
      toggleBtn.setAttribute('aria-label', chatOpen ? 'Close AI chat assistant' : 'Open AI chat assistant');
    }

    // Use CSS classes for better control and smoother animations
    if (chatOpen) {
      chatWindow.classList.add('ai-chat-open');
    } else {
      chatWindow.classList.remove('ai-chat-open');
    }

    console.log('‚úÖ AI Widget: Chat window toggled to:', chatOpen ? 'open' : 'closed');
    console.log('üîç AI Widget: Chat window classes:', chatWindow.className);
    console.log('üîç AI Widget: Chat window computed display:', window.getComputedStyle(chatWindow).display);

    if (chatOpen) {
      // ‚ú® ACCESSIBILITY: Focus input field when opening
      const inputField = document.getElementById('ai-chat-input-field');
      if (inputField) {
        // Wait for CSS transition to start before focusing
        setTimeout(() => inputField.focus(), 200);
      }
      // Ensure scroll starts at the top when chat opens
      setTimeout(() => {
        scrollToTop();
      }, 250);
    } else {
      // ‚ú® ACCESSIBILITY: Return focus to toggle button when closing
      if (toggleBtn) {
        setTimeout(() => toggleBtn.focus(), 100);
      }
    }
  };
  
  // Handle enter key press
  window.handleChatKeyPress = function(event) {
    if (event.key === 'Enter') {
      sendAIMessage();
    }
  };
  
  // Send message to AI
  window.sendAIMessage = function() {
    const inputField = document.getElementById('ai-chat-input-field');
    const message = inputField.value.trim();

    if (!message) return;

    // üìä ANALYTICS: Track message sent
    trackAnalytics(analyticsEvents.MESSAGE_SENT, {
      messageLength: message.length,
      conversationPosition: conversationHistory.length + 1
    });

    // üåê OFFLINE SUPPORT: Queue message if offline
    if (!isOnline) {
      addMessageToChat('user', `${message} üì≠ (Queued)`);
      messageQueue.push({
        message,
        timestamp: Date.now()
      });
      saveMessageQueue();
      inputField.value = '';
      showNotification('Message queued. Will send when online.', 'info');
      return;
    }

    // Hide welcome screen after first message
    hideWelcomeScreen();

    // Add user message to chat
    addMessageToChat('user', message);
    inputField.value = '';

    // Show loading
    showLoading(true);
    
    // Send to AI service using the app proxy (single endpoint for both settings and chat)
    const shopUrl = '{{ shop.url }}';
    
    // Function to send message via app proxy
    const sendChatMessage = async () => {
      console.log('üöÄ Sending chat message via app proxy');

      // ‚ú® DEBUG: Log detected language
      const detectedLocale = navigator.language || navigator.userLanguage || 'en';
      console.log('üåç Detected browser language:', detectedLocale);
      console.log('üí∞ Shop currency:', '{{ shop.currency }}');

      try {
        // Build context object
        const contextData = {
          page: window.location.pathname,
          productId: getProductIdFromPage(),
          conversationHistory: conversationHistory,
          shopDomain: '{{ shop.myshopify_domain }}',
          // ‚ú® NEW: Detect user's browser language
          locale: navigator.language || navigator.userLanguage || 'en',
          // Also send currency from Shopify if available
          currency: '{{ shop.currency }}' || 'USD'
        };

        // ‚ú® DEBUG: Log full context being sent
        console.log('üì§ Sending context:', JSON.stringify(contextData, null, 2));

        const response = await fetchWithRetry(`${shopUrl}/apps/widget-settings`, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-Shopify-Shop-Domain': '{{ shop.myshopify_domain }}',
             'X-Shopify-Customer-Access-Token': '{{ customer.access_token | default: "" }}',
           },
           body: JSON.stringify({
             userMessage: message,
             products: [],
             context: contextData
           })
         });

         console.log('‚úÖ Success! Chat message sent via app proxy');
         return await response.json();
       } catch (error) {
         console.log('‚ùå Failed to send chat message via app proxy:', error);
         throw error;
       }
     };
     
     // Send the chat message
     sendChatMessage()
      .then(data => {
      showLoading(false);

      // Handle both old format (data.response) and new N8N format (data.message)
      let responseMessage = data.response || data.message;

      if (responseMessage) {
        // üìä ANALYTICS: Track message received
        trackAnalytics(analyticsEvents.MESSAGE_RECEIVED, {
          responseLength: responseMessage.length,
          hasRecommendations: !!(data.recommendations && data.recommendations.length > 0),
          hasSuggestions: !!(data.quickReplies && data.quickReplies.length > 0)
        });

        // Add the main AI response
        addMessageToChat('assistant', responseMessage);

        // ‚ú® NEW: Display product recommendations with enhanced cards
        if (data.recommendations && data.recommendations.length > 0) {
          displayProductRecommendations(data.recommendations);
        }

        // ‚ú® NEW: Display quick replies if available
        if (data.quickReplies && data.quickReplies.length > 0) {
          displayQuickReplies(data.quickReplies);
        } else {
          // Clear quick replies if none provided
          displayQuickReplies([]);
        }

        // ‚ú® NEW: Display suggested actions if available
        if (data.suggestedActions && data.suggestedActions.length > 0) {
          displaySuggestedActions(data.suggestedActions);
        } else {
          // Clear suggested actions if none provided
          displaySuggestedActions([]);
        }

        // ‚ú® NEW: Track sentiment for styling
        if (data.sentiment) {
          currentSentiment = data.sentiment;
          applySentimentStyling(data.sentiment);
        }

        // ‚ú® NEW: Human escalation prompt
        if (data.requiresHumanEscalation) {
          displayHumanEscalationPrompt();
        }

        // Update conversation history
        conversationHistory.push(
          { role: 'user', content: message },
          { role: 'assistant', content: responseMessage }
        );

        // Keep only last 10 messages
        if (conversationHistory.length > 10) {
          conversationHistory = conversationHistory.slice(-10);
        }

        // ‚úÖ FEATURE: Save conversation to localStorage
        saveConversationHistory();
      } else {
        addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
      }
    })
    .catch(error => {
      showLoading(false);
      console.error('AI Assistant Error:', error);

      // üìä ANALYTICS: Track error
      trackAnalytics(analyticsEvents.ERROR_OCCURRED, {
        errorMessage: error.message,
        errorType: error.name
      });

      addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
    });
  };
  
  // Add message to chat
  function addMessageToChat(sender, message) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${sender}-message`;

    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';

    // ‚úÖ XSS FIX: Use textContent and createElement instead of innerHTML
    // Split message by newlines and create text nodes with <br> elements
    const cleanMessage = message.trim();
    const lines = cleanMessage.split('\n');

    lines.forEach((line, index) => {
      // Create text node for each line (safe from XSS)
      const textNode = document.createTextNode(line);
      messageContent.appendChild(textNode);

      // Add line break if not the last line
      if (index < lines.length - 1) {
        messageContent.appendChild(document.createElement('br'));
      }
    });

    messageDiv.appendChild(messageContent);
    messagesContainer.appendChild(messageDiv);

    // Scroll to bottom with smooth animation
    scrollToBottom();
  }
  
  // Smooth scroll to bottom function
  function scrollToBottom() {
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      // Use setTimeout to ensure the new message is rendered before scrolling
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 10);
    }
  }
  
  // Smooth scroll to top function
  function scrollToTop() {
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      // Use setTimeout to ensure the chat window is fully rendered before scrolling
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }, 10);
    }
  }

  // ‚ú® NEW: Display quick reply buttons
  function displayQuickReplies(quickReplies) {
    if (!quickReplies || quickReplies.length === 0) {
      currentQuickReplies = [];
      const container = document.getElementById('quick-replies-container');
      if (container) container.remove();
      return;
    }

    currentQuickReplies = quickReplies;

    // Remove existing quick replies
    const existingContainer = document.getElementById('quick-replies-container');
    if (existingContainer) existingContainer.remove();

    // Create quick replies container
    const container = document.createElement('div');
    container.id = 'quick-replies-container';
    container.style.cssText = `
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(to bottom, #f9fafb, #ffffff);
      border-top: 1px solid #e5e7eb;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    `;

    // Create quick reply buttons
    quickReplies.forEach(reply => {
      const button = document.createElement('button');
      button.textContent = reply;
      button.className = 'quick-reply-btn';
      button.style.cssText = `
        background: white;
        border: 1.5px solid ${widgetSettings.primaryColor || '#ee5cee'};
        color: ${widgetSettings.primaryColor || '#ee5cee'};
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s ease;
        flex-shrink: 0;
      `;

      // Hover effect
      button.onmouseover = () => {
        button.style.background = widgetSettings.primaryColor || '#ee5cee';
        button.style.color = 'white';
        button.style.transform = 'translateY(-1px)';
        button.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
      };
      button.onmouseout = () => {
        button.style.background = 'white';
        button.style.color = widgetSettings.primaryColor || '#ee5cee';
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = 'none';
      };

      // Click handler
      button.onclick = () => {
        // üìä ANALYTICS: Track suggestion click
        trackAnalytics(analyticsEvents.SUGGESTION_CLICKED, {
          suggestion: reply
        });

        const inputField = document.getElementById('ai-chat-input-field');
        if (inputField) {
          inputField.value = reply;
          sendAIMessage();
        }
      };

      container.appendChild(button);
    });

    // Insert before the input field
    const chatFooter = document.querySelector('.ai-chat-footer') ||
                       document.getElementById('ai-chat-input-field')?.parentElement;
    if (chatFooter) {
      chatFooter.insertBefore(container, chatFooter.firstChild);
    }
  }

  // ‚ú® NEW: Display Suggested Actions Bar
  function displaySuggestedActions(suggestedActions) {
    // Clear if no actions
    if (!suggestedActions || suggestedActions.length === 0) {
      currentSuggestedActions = [];
      const existingBar = document.getElementById('suggested-actions-bar');
      if (existingBar) existingBar.remove();
      return;
    }

    currentSuggestedActions = suggestedActions;

    // Remove existing actions bar
    const existingBar = document.getElementById('suggested-actions-bar');
    if (existingBar) existingBar.remove();

    // Create actions bar container
    const actionsBar = document.createElement('div');
    actionsBar.id = 'suggested-actions-bar';
    actionsBar.style.cssText = `
      display: flex;
      gap: 10px;
      padding: 16px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      margin: 12px 0;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    `;

    // Create action buttons
    suggestedActions.forEach(action => {
      const button = document.createElement('button');
      button.textContent = action.label;
      button.className = 'suggested-action-btn';

      // Icon based on action type
      const icons = {
        'view_product': 'üëÅÔ∏è',
        'add_to_cart': 'üõí',
        'compare': '‚öñÔ∏è',
        'custom': '‚ú®'
      };
      const icon = icons[action.action] || '‚ñ∂Ô∏è';

      button.style.cssText = `
        background: ${widgetSettings.primaryColor || '#ee5cee'};
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        flex: 1;
        min-width: 140px;
        justify-content: center;
      `;

      // Add icon before text
      button.innerHTML = `<span style="font-size: 16px;">${icon}</span> ${escapeHTML(action.label)}`;

      // Hover effects
      button.onmouseover = () => {
        button.style.transform = 'translateY(-2px)';
        button.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        button.style.filter = 'brightness(1.1)';
      };
      button.onmouseout = () => {
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';
        button.style.filter = 'brightness(1)';
      };

      // Click handler
      button.onclick = () => {
        handleSuggestedAction(action);
      };

      actionsBar.appendChild(button);
    });

    // Insert after the last message in chat
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      messagesContainer.appendChild(actionsBar);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  // ‚ú® NEW: Show notification (for cart actions)
  function showNotification(message, type = 'success') {
    // Remove existing notification
    const existingNotif = document.getElementById('cart-notification');
    if (existingNotif) existingNotif.remove();

    // Create notification
    const notification = document.createElement('div');
    notification.id = 'cart-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : '#ef4444'};
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 999999;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 600;
      animation: slideInRight 0.3s ease;
    `;

    const icon = document.createElement('span');
    icon.style.fontSize = '20px';
    icon.textContent = type === 'success' ? '‚úÖ' : '‚ùå';
    notification.appendChild(icon);

    const text = document.createElement('span');
    text.textContent = message;
    notification.appendChild(text);

    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // ‚ú® NEW: Add product to Shopify cart
  async function addToCart(productHandle, variantId, quantity = 1) {
    try {
      showNotification('Adding to cart...', 'info');

      // If we have a variant ID, use it directly
      if (variantId) {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: variantId,
              quantity: quantity
            }]
          })
        });

        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }

        const data = await response.json();
        showNotification('Added to cart! üõí', 'success');

        // Update cart count if there's a cart icon on the page
        updateCartCount();
        return true;
      } else {
        // If no variant ID, fetch product to get first available variant
        const productResponse = await fetch(`/products/${productHandle}.js`);
        if (!productResponse.ok) {
          throw new Error('Product not found');
        }

        const product = await productResponse.json();
        const firstAvailableVariant = product.variants.find(v => v.available);

        if (!firstAvailableVariant) {
          throw new Error('Product is out of stock');
        }

        // Add the first available variant
        const addResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: firstAvailableVariant.id,
              quantity: quantity
            }]
          })
        });

        if (!addResponse.ok) {
          throw new Error('Failed to add to cart');
        }

        showNotification('Added to cart! üõí', 'success');
        updateCartCount();
        return true;
      }
    } catch (error) {
      console.error('Cart error:', error);
      showNotification('Failed to add to cart', 'error');
      return false;
    }
  }

  // ‚ú® NEW: Update cart count badge
  function updateCartCount() {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        // Try to find and update cart count elements
        const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, #cart-count');
        cartCountElements.forEach(el => {
          el.textContent = cart.item_count;
        });
      })
      .catch(err => console.error('Failed to update cart count:', err));
  }

  // ‚ú® NEW: Handle Suggested Action clicks
  function handleSuggestedAction(action) {
    switch(action.action) {
      case 'view_product':
        // Open product page
        if (action.data) {
          const productUrl = action.data.startsWith('http')
            ? action.data
            : `/products/${action.data}`;
          const safeUrl = sanitizeUrl(productUrl);
          if (safeUrl) {
            window.open(safeUrl, '_blank', 'noopener,noreferrer');
          }
        }
        break;

      case 'add_to_cart':
        // ‚ú® ENHANCED: Full cart integration
        if (action.data) {
          // action.data can be product handle or variant ID
          const isVariantId = /^\d+$/.test(action.data);
          if (isVariantId) {
            addToCart(null, action.data);
          } else {
            addToCart(action.data, null);
          }
        }
        break;

      case 'compare':
        // Compare products (future feature)
        console.log('Compare products:', action.data);
        addMessageToChat('assistant', 'Product comparison feature coming soon! ‚öñÔ∏è');
        break;

      case 'custom':
        // Custom action - can be extended
        console.log('Custom action:', action.data);
        break;

      default:
        console.log('Unknown action:', action.action);
    }
  }

  // ‚ú® NEW: Display Human Escalation Prompt
  function displayHumanEscalationPrompt() {
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (!messagesContainer) return;

    // Check if escalation prompt already exists
    const existingPrompt = document.getElementById('escalation-prompt');
    if (existingPrompt) return; // Don't show multiple times

    // Create escalation prompt container
    const escalationPrompt = document.createElement('div');
    escalationPrompt.id = 'escalation-prompt';
    escalationPrompt.className = 'ai-message assistant-message';
    escalationPrompt.style.cssText = `
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      border-radius: 16px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    `;

    // Header with icon
    const header = document.createElement('div');
    header.style.cssText = `
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    `;

    const icon = document.createElement('span');
    icon.style.fontSize = '28px';
    icon.textContent = 'üë§';
    header.appendChild(icon);

    const title = document.createElement('h3');
    title.style.cssText = `
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #991b1b;
    `;
    title.textContent = 'Need to speak with a human?';
    header.appendChild(title);

    escalationPrompt.appendChild(header);

    // Message
    const message = document.createElement('p');
    message.style.cssText = `
      margin: 0 0 16px 0;
      font-size: 14px;
      color: #7f1d1d;
      line-height: 1.5;
    `;
    message.textContent = 'It looks like you might need personalized assistance. Our support team is ready to help you!';
    escalationPrompt.appendChild(message);

    // Action buttons
    const buttonsContainer = document.createElement('div');
    buttonsContainer.style.cssText = `
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    `;

    // Connect button
    const connectBtn = document.createElement('button');
    connectBtn.textContent = 'üí¨ Talk to Support';
    connectBtn.style.cssText = `
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 140px;
    `;

    connectBtn.onmouseover = () => {
      connectBtn.style.background = '#dc2626';
      connectBtn.style.transform = 'translateY(-1px)';
      connectBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    };
    connectBtn.onmouseout = () => {
      connectBtn.style.background = '#ef4444';
      connectBtn.style.transform = 'translateY(0)';
      connectBtn.style.boxShadow = 'none';
    };

    connectBtn.onclick = () => {
      // Open contact page or support email
      // You can customize this URL to your shop's contact page
      const safeUrl = sanitizeUrl('/pages/contact');
      if (safeUrl) {
        window.open(safeUrl, '_blank', 'noopener,noreferrer');
      }
    };
    buttonsContainer.appendChild(connectBtn);

    // Continue with AI button
    const continueBtn = document.createElement('button');
    continueBtn.textContent = 'ü§ñ Continue with AI';
    continueBtn.style.cssText = `
      background: white;
      color: #ef4444;
      border: 2px solid #ef4444;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 140px;
    `;

    continueBtn.onmouseover = () => {
      continueBtn.style.background = '#fef2f2';
      continueBtn.style.transform = 'translateY(-1px)';
    };
    continueBtn.onmouseout = () => {
      continueBtn.style.background = 'white';
      continueBtn.style.transform = 'translateY(0)';
    };

    continueBtn.onclick = () => {
      // Just dismiss the prompt
      escalationPrompt.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => escalationPrompt.remove(), 300);
      addMessageToChat('assistant', 'No problem! I\'m here to help. What else can I assist you with? üòä');
    };
    buttonsContainer.appendChild(continueBtn);

    escalationPrompt.appendChild(buttonsContainer);

    // Insert into messages
    messagesContainer.appendChild(escalationPrompt);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Display enhanced product recommendations
  function displayProductRecommendations(recommendations) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    
    // Add a container for all product cards
    const productsContainer = document.createElement('div');
    productsContainer.className = 'ai-message assistant-message products-grid-container';
    productsContainer.style.marginBottom = '16px';
    productsContainer.style.maxWidth = '100%';
    productsContainer.style.width = '100%';
    
    const gridContent = document.createElement('div');
    gridContent.className = 'products-grid';
    gridContent.style.display = 'grid';
    gridContent.style.gridTemplateColumns = recommendations.length === 1 ? '1fr' : 'repeat(auto-fit, minmax(280px, 1fr))';
    gridContent.style.gap = '12px';
    gridContent.style.padding = '0';
    gridContent.style.width = '100%';
    
    recommendations.forEach((product, index) => {
      // Create individual product card
      const productCard = document.createElement('div');
      productCard.className = 'product-card clickable-product';
      productCard.style.backgroundColor = '#fff';
      productCard.style.border = '1px solid #e5e7eb';
      productCard.style.borderRadius = '12px';
      productCard.style.overflow = 'hidden';
      productCard.style.cursor = 'pointer';
      productCard.style.transition = 'all 0.3s ease';
      productCard.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
      productCard.style.position = 'relative';

      // ‚úÖ XSS FIX: Build product card using DOM methods instead of innerHTML

      // Product image (if available)
      if (product.image) {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'product-image';
        imageDiv.style.width = '100%';
        imageDiv.style.height = '160px';
        // Sanitize URL to prevent XSS
        const sanitizedImageUrl = sanitizeUrl(product.image);
        if (sanitizedImageUrl) {
          // CSS.escape for additional safety in CSS context
          const escapedUrl = sanitizedImageUrl.replace(/'/g, "\\'");
          imageDiv.style.backgroundImage = `url('${escapedUrl}')`;
        }
        imageDiv.style.backgroundSize = 'cover';
        imageDiv.style.backgroundPosition = 'center';
        imageDiv.style.backgroundColor = '#f8f9fa';
        imageDiv.style.position = 'relative';

        // ‚ú® ENHANCED: Top-left badges (discount, low stock)
        const badgesContainer = document.createElement('div');
        badgesContainer.style.position = 'absolute';
        badgesContainer.style.top = '8px';
        badgesContainer.style.left = '8px';
        badgesContainer.style.display = 'flex';
        badgesContainer.style.flexDirection = 'column';
        badgesContainer.style.gap = '6px';

        // Discount badge (if available)
        if (product.badge || product.discountPercent) {
          const discountBadge = document.createElement('div');
          discountBadge.style.background = '#ef4444';
          discountBadge.style.color = 'white';
          discountBadge.style.padding = '4px 10px';
          discountBadge.style.borderRadius = '6px';
          discountBadge.style.fontSize = '12px';
          discountBadge.style.fontWeight = '700';
          discountBadge.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          discountBadge.textContent = product.badge || `${product.discountPercent}% OFF`;
          badgesContainer.appendChild(discountBadge);
        }

        // Low stock badge (if low stock)
        if (product.isLowStock && product.inventory) {
          const stockBadge = document.createElement('div');
          stockBadge.style.background = '#f59e0b';
          stockBadge.style.color = 'white';
          stockBadge.style.padding = '4px 10px';
          stockBadge.style.borderRadius = '6px';
          stockBadge.style.fontSize = '11px';
          stockBadge.style.fontWeight = '600';
          stockBadge.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          stockBadge.textContent = `Only ${product.inventory} left!`;
          badgesContainer.appendChild(stockBadge);
        }

        if (badgesContainer.children.length > 0) {
          imageDiv.appendChild(badgesContainer);
        }

        // ‚ú® ENHANCED: Match score badge (top-right)
        if (product.relevanceScore) {
          const matchBadge = document.createElement('div');
          matchBadge.style.position = 'absolute';
          matchBadge.style.top = '8px';
          matchBadge.style.right = '8px';
          matchBadge.style.background = 'rgba(0, 0, 0, 0.7)';
          matchBadge.style.color = 'white';
          matchBadge.style.padding = '4px 8px';
          matchBadge.style.borderRadius = '12px';
          matchBadge.style.fontSize = '11px';
          matchBadge.style.fontWeight = '600';
          matchBadge.style.backdropFilter = 'blur(4px)';
          matchBadge.textContent = `${product.relevanceScore}% match`;
          imageDiv.appendChild(matchBadge);
        }

        productCard.appendChild(imageDiv);
      }

      // Product details container
      const detailsDiv = document.createElement('div');
      detailsDiv.style.padding = '16px';

      // Product title
      const titleH4 = document.createElement('h4');
      titleH4.style.margin = '0 0 8px 0';
      titleH4.style.fontSize = '16px';
      titleH4.style.fontWeight = '600';
      titleH4.style.color = '#1f2937';
      titleH4.style.lineHeight = '1.3';
      titleH4.style.display = '-webkit-box';
      titleH4.style.webkitLineClamp = '2';
      titleH4.style.webkitBoxOrient = 'vertical';
      titleH4.style.overflow = 'hidden';
      titleH4.textContent = product.title || 'Untitled Product'; // Safe textContent
      detailsDiv.appendChild(titleH4);

      // ‚ú® ENHANCED: Rating stars (if available)
      if (product.rating || product.reviewCount) {
        const ratingDiv = document.createElement('div');
        ratingDiv.style.display = 'flex';
        ratingDiv.style.alignItems = 'center';
        ratingDiv.style.gap = '6px';
        ratingDiv.style.marginBottom = '8px';

        // Star rating
        const rating = product.rating || 0;
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        const starsSpan = document.createElement('span');
        starsSpan.style.color = '#fbbf24';
        starsSpan.style.fontSize = '14px';
        starsSpan.textContent = '‚òÖ'.repeat(fullStars) + (hasHalfStar ? '¬Ω' : '') + '‚òÜ'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
        ratingDiv.appendChild(starsSpan);

        // Review count
        if (product.reviewCount) {
          const reviewSpan = document.createElement('span');
          reviewSpan.style.fontSize = '12px';
          reviewSpan.style.color = '#6b7280';
          reviewSpan.textContent = `(${product.reviewCount})`;
          ratingDiv.appendChild(reviewSpan);
        }

        detailsDiv.appendChild(ratingDiv);
      }

      // ‚ú® ENHANCED: Price display with strikethrough for discounts
      const priceRow = document.createElement('div');
      priceRow.style.display = 'flex';
      priceRow.style.justifyContent = 'space-between';
      priceRow.style.alignItems = 'center';
      priceRow.style.marginBottom = '12px';

      const priceContainer = document.createElement('div');
      priceContainer.style.display = 'flex';
      priceContainer.style.flexDirection = 'column';
      priceContainer.style.gap = '2px';

      // Show original price with strikethrough if discounted
      if (product.compareAtPrice && parseFloat(product.compareAtPrice) > parseFloat(product.price)) {
        const originalPriceSpan = document.createElement('span');
        originalPriceSpan.style.fontSize = '13px';
        originalPriceSpan.style.color = '#9ca3af';
        originalPriceSpan.style.textDecoration = 'line-through';
        originalPriceSpan.textContent = `$${parseFloat(product.compareAtPrice).toFixed(2)}`;
        priceContainer.appendChild(originalPriceSpan);
      }

      // Current price
      const priceDiv = document.createElement('div');
      priceDiv.style.fontSize = '20px';
      priceDiv.style.fontWeight = '700';
      priceDiv.style.color = product.compareAtPrice ? '#ef4444' : widgetSettings.primaryColor;
      priceDiv.textContent = product.priceFormatted || `$${parseFloat(product.price || '0').toFixed(2)}`;
      priceContainer.appendChild(priceDiv);

      priceRow.appendChild(priceContainer);

      if (product.category) {
        const categoryDiv = document.createElement('div');
        categoryDiv.style.background = '#f3f4f6';
        categoryDiv.style.color = '#6b7280';
        categoryDiv.style.padding = '2px 8px';
        categoryDiv.style.borderRadius = '8px';
        categoryDiv.style.fontSize = '11px';
        categoryDiv.style.fontWeight = '500';
        categoryDiv.textContent = product.category; // Safe textContent
        priceRow.appendChild(categoryDiv);
      }
      detailsDiv.appendChild(priceRow);

      // Description
      const descP = document.createElement('p');
      descP.style.margin = '0 0 12px 0';
      descP.style.fontSize = '13px';
      descP.style.color = '#6b7280';
      descP.style.lineHeight = '1.4';
      descP.style.display = '-webkit-box';
      descP.style.webkitLineClamp = '3';
      descP.style.webkitBoxOrient = 'vertical';
      descP.style.overflow = 'hidden';
      descP.textContent = product.description || 'No description available'; // Safe textContent
      detailsDiv.appendChild(descP);

      // ‚ú® ENHANCED: Urgency message (if available)
      if (product.urgencyMessage) {
        const urgencyDiv = document.createElement('div');
        urgencyDiv.style.display = 'flex';
        urgencyDiv.style.alignItems = 'center';
        urgencyDiv.style.gap = '6px';
        urgencyDiv.style.background = '#fef3c7';
        urgencyDiv.style.color = '#92400e';
        urgencyDiv.style.padding = '8px 12px';
        urgencyDiv.style.borderRadius = '8px';
        urgencyDiv.style.fontSize = '12px';
        urgencyDiv.style.fontWeight = '600';
        urgencyDiv.style.marginBottom = '12px';
        urgencyDiv.style.border = '1px solid #fcd34d';

        const iconSpan = document.createElement('span');
        iconSpan.textContent = '‚ö°';
        iconSpan.style.fontSize = '14px';
        urgencyDiv.appendChild(iconSpan);

        const textSpan = document.createElement('span');
        textSpan.textContent = product.urgencyMessage;
        urgencyDiv.appendChild(textSpan);

        detailsDiv.appendChild(urgencyDiv);
      }

      // Tags (if available)
      if (product.tags && product.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.style.marginBottom = '12px';

        product.tags.slice(0, 3).forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.style.display = 'inline-block';
          tagSpan.style.background = '#e5e7eb';
          tagSpan.style.color = '#374151';
          tagSpan.style.padding = '2px 6px';
          tagSpan.style.borderRadius = '6px';
          tagSpan.style.fontSize = '10px';
          tagSpan.style.marginRight = '4px';
          tagSpan.style.marginBottom = '4px';
          tagSpan.textContent = tag; // Safe textContent
          tagsDiv.appendChild(tagSpan);
        });

        detailsDiv.appendChild(tagsDiv);
      }

      // Action button
      const actionButton = document.createElement('div');
      actionButton.style.background = widgetSettings.primaryColor;
      actionButton.style.color = 'white';
      actionButton.style.textAlign = 'center';
      actionButton.style.padding = '10px';
      actionButton.style.borderRadius = '8px';
      actionButton.style.fontSize = '14px';
      actionButton.style.fontWeight = '600';
      actionButton.style.marginTop = 'auto';
      actionButton.textContent = 'View Product ‚Üí';
      detailsDiv.appendChild(actionButton);

      productCard.appendChild(detailsDiv);
      
      // Add click handler to open product page
      productCard.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // üìä ANALYTICS: Track product click
        trackAnalytics(analyticsEvents.PRODUCT_CLICKED, {
          productTitle: product.title,
          productHandle: product.handle,
          productPrice: product.price,
          relevanceScore: product.relevanceScore
        });

        // Use full URL if available, otherwise construct relative URL
        const productUrl = product.fullUrl || `/products/${product.handle}`;
        const safeUrl = sanitizeUrl(productUrl);
        if (safeUrl) {
          window.open(safeUrl, '_blank', 'noopener,noreferrer');
        }

        // Add visual feedback
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 150);
      });
      
      // Add hover effects
      productCard.addEventListener('mouseenter', function() {
        this.style.borderColor = widgetSettings.primaryColor;
        this.style.transform = 'translateY(-4px)';
        this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
      });
      
      productCard.addEventListener('mouseleave', function() {
        this.style.borderColor = '#e5e7eb';
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
      });
      
      gridContent.appendChild(productCard);
    });
    
    productsContainer.appendChild(gridContent);
    messagesContainer.appendChild(productsContainer);
    
    // Add a "Browse More Products" button if there are multiple recommendations
    if (recommendations.length > 2) {
      const browseMoreDiv = document.createElement('div');
      browseMoreDiv.className = 'ai-message assistant-message';
      browseMoreDiv.style.marginTop = '8px';
      browseMoreDiv.style.textAlign = 'center';
      
      const browseButton = document.createElement('button');
      browseButton.style.background = 'transparent';
      browseButton.style.border = `2px solid ${widgetSettings.primaryColor}`;
      browseButton.style.color = widgetSettings.primaryColor;
      browseButton.style.padding = '10px 20px';
      browseButton.style.borderRadius = '25px';
      browseButton.style.fontSize = '14px';
      browseButton.style.fontWeight = '600';
      browseButton.style.cursor = 'pointer';
      browseButton.style.transition = 'all 0.2s ease';
      browseButton.textContent = 'Browse All Products';
      
      browseButton.addEventListener('click', function() {
        const safeUrl = sanitizeUrl('/collections/all');
        if (safeUrl) {
          window.open(safeUrl, '_blank', 'noopener,noreferrer');
        }
      });
      
      browseButton.addEventListener('mouseenter', function() {
        this.style.backgroundColor = widgetSettings.primaryColor;
        this.style.color = 'white';
      });
      
      browseButton.addEventListener('mouseleave', function() {
        this.style.backgroundColor = 'transparent';
        this.style.color = widgetSettings.primaryColor;
      });
      
      browseMoreDiv.appendChild(browseButton);
      messagesContainer.appendChild(browseMoreDiv);
    }
    
    // Scroll to bottom after adding recommendations
    scrollToBottom();
  }
  
  // Show/hide loading indicator
  // üíÄ ENHANCED: Skeleton loading with smooth animations
  function showLoading(show) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    let loadingDiv = document.getElementById('ai-loading');

    if (show) {
      // Remove any existing loading indicator first
      if (loadingDiv) {
        loadingDiv.remove();
      }

      // Create skeleton loading message
      loadingDiv = document.createElement('div');
      loadingDiv.id = 'ai-loading';
      loadingDiv.className = 'ai-message assistant-message skeleton-message';

      // Create skeleton lines
      for (let i = 0; i < 3; i++) {
        const line = document.createElement('div');
        line.className = 'skeleton skeleton-line';
        line.style.width = i === 2 ? '60%' : '100%';
        loadingDiv.appendChild(line);
      }

      // Find the last actual message (excluding welcome message) and insert loading after it
      if (messagesContainer) {
        // Get all message elements, excluding the welcome message
        const allMessages = messagesContainer.querySelectorAll('.ai-message:not(.ai-welcome-message)');

        if (allMessages.length > 0) {
          // Insert after the last actual message
          const lastMessage = allMessages[allMessages.length - 1];
          lastMessage.insertAdjacentElement('afterend', loadingDiv);
        } else {
          // If no actual messages yet, append to container
          messagesContainer.appendChild(loadingDiv);
        }

        // Auto-scroll to show the loading indicator
        scrollToBottom();
      }
    } else {
      // Hide/remove loading indicator with fade out
      if (loadingDiv) {
        loadingDiv.style.opacity = '0';
        loadingDiv.style.transition = 'opacity 0.3s ease';
        setTimeout(() => loadingDiv.remove(), 300);
      }
    }
  }
  
  // Hide welcome screen after first interaction
  function hideWelcomeScreen() {
    const welcomeMessage = document.querySelector('.ai-welcome-message');
    if (welcomeMessage) {
      welcomeMessage.style.display = 'none';
      console.log('‚úÖ AI Widget: Welcome screen hidden');
    }
  }
  
  // Get product ID from current page
  function getProductIdFromPage() {
    const productMatch = window.location.pathname.match(/\/products\/([^\/]+)/);
    if (productMatch) {
      return productMatch[1];
    }
    return null;
  }
  
  // Load widget settings and initialize
  async function initializeWidget() {
    try {
      // ‚úÖ FEATURE: Load conversation history from localStorage
      loadConversationHistory();

      // Use block settings or fetch from API as fallback
      widgetSettings = blockSettings;

      // Debug current context
      console.log('üè™ Current shop domain:', window.Shopify?.shop || '{{ shop.permanent_domain }}');
      console.log('üåê Current location:', window.location.href);
      console.log('üîß Block settings:', blockSettings);
      
      // Try to fetch updated settings from API
      const shopDomain = window.Shopify?.shop || '{{ shop.permanent_domain }}';
      // Use app proxy URL (proper way for theme extensions)
      const shopUrl = '{{ shop.url }}';
      const possibleSettingsUrls = [
        // Use app proxy URL - requests are forwarded to your app server
        shopUrl + '/apps/widget-settings',
        // Fallback to current host
        window.location.protocol + '//' + window.location.host + '/apps/widget-settings'
      ];
      
      let apiSuccess = false;
      for (const appUrl of possibleSettingsUrls) {
        try {
          console.log(`üîÑ AI Widget: Trying to fetch settings from ${appUrl}`);
          const timestamp = Date.now();
          const response = await fetchWithRetry(`${appUrl}?shop=${shopDomain}&t=${timestamp}`, {}, 2);
          const data = await response.json();
          console.log(`‚úÖ AI Widget: Successfully fetched settings from ${appUrl}`, data.settings);

          // Detect if we're in theme editor (multiple ways to check)
          const isThemeEditor = !!(
            window.Shopify?.designMode ||
            window.location.search.includes('oseid=') ||
            window.location.pathname.includes('/editor')
          );

          console.log('üé® Theme Editor Detection:', {
            'Shopify.designMode': window.Shopify?.designMode,
            'URL has oseid': window.location.search.includes('oseid='),
            'Is theme editor': isThemeEditor
          });

          // In theme editor, prioritize block settings; on storefront, prioritize API settings
          if (isThemeEditor) {
            widgetSettings = { ...data.settings, ...blockSettings };  // Theme editor: block settings override
            console.log('üé® Theme Editor Mode: Using block settings to override API settings');
          } else {
            widgetSettings = { ...blockSettings, ...data.settings }; // Storefront: API settings override
            console.log('üåê Storefront Mode: Using API settings to override block settings');
          }
          apiSuccess = true;

          // Initialize lastSettingsUpdate with current timestamp for auto-refresh
          if (typeof window.lastSettingsUpdate === 'undefined') {
            window.lastSettingsUpdate = data.settings.updatedAt;
          }
          break;
        } catch (e) {
          console.log(`‚ùå AI Widget: Error fetching from ${appUrl}:`, e);
          continue;
        }
      }
      
      if (!apiSuccess) {
        console.log('‚ö†Ô∏è AI Widget: Could not fetch settings from API, using block settings', blockSettings);
      }
      
      // Debug logging
      console.log('AI Widget: Settings loaded (updated):', widgetSettings);
      
      // Only create widget if enabled
      if (!widgetSettings.enabled) {
        console.log('AI Widget: Disabled, not creating widget');
        return;
      }
      
      // Create the widget HTML
      createWidget();
      
      // Add debugging to console to verify settings are applied
      console.log('AI Widget: Widget created with settings:', {
        position: widgetSettings.position,
        primaryColor: widgetSettings.primaryColor,
        buttonText: widgetSettings.buttonText,
        chatTitle: widgetSettings.chatTitle
      });
      
    } catch (error) {
      console.error('Failed to load AI Sales Assistant settings:', error);
      // Use block settings as fallback
      widgetSettings = blockSettings;
      if (widgetSettings.enabled) {
        createWidget();
      }
    }
  }
  
  // Create the widget HTML
  function createWidget() {
    const container = document.getElementById('ai-sales-assistant-container');
    if (!container || !widgetSettings) return;
    
    console.log('AI Widget: Creating widget with position:', widgetSettings.position);
    
    // Clear any existing widget
    container.innerHTML = '';
    
    // ‚úÖ XSS FIX: Escape all widget settings before injecting into HTML
    const safePosition = String(widgetSettings.position).replace(/[^a-z-]/gi, ''); // Only allow letters and hyphens
    const safeButtonText = escapeHTML(widgetSettings.buttonText);
    const safeChatTitle = escapeHTML(widgetSettings.chatTitle);
    const safeWelcomeMessage = escapeHTML(widgetSettings.welcomeMessage);
    const safeInputPlaceholder = escapeHTML(widgetSettings.inputPlaceholder);
    const safePrimaryColor = sanitizeColor(widgetSettings.primaryColor);

    container.innerHTML = `
      <div class="ai-sales-assistant-widget position-${safePosition}" data-widget-id="ai-sales-assistant">
        <!-- Chat Toggle Button -->
        <button
          class="ai-chat-toggle"
          id="ai-chat-toggle-btn"
          style="background-color: ${safePrimaryColor};"
          aria-label="Open AI chat assistant"
          aria-expanded="false"
          aria-controls="ai-chat-window"
        >
          <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAABJlBMVEVHcEwb49o9s+I0v+BIoOUuyN9Ui+hZg+pdfOsc49tMl+ZViuke4NtOk+ce39sc4ts3t+Ej19xbf+pTi+gl1N1GoOVCp+RWh+kxwuAa5tpFo+Ue39s0vuAsyt4i2NxIneYpzd5Ml+Yry946suJUiuldfOs6suIc49oZ59oa5do/q+Neeusxwt8Y6dka5touxt88sOJcfupZgupcfuo0veBefOpcfuoZ5toiIiI8sOI2ueFCp+RFouVInuU5tOE/q+MzveAxwt8uxt9LmedQkOdWh+kry98o0N0hHx9Ui+gl1Nwi2dwf3dtOlOZZgulcfuomTFYsRFcrhZc+ZpxUjes4cJsyepkjP0Ei2t0lxs1ImOBPluomy9ZEcbFBo95KgMsmmaIkZ2ysswjsAAAAOHRSTlMA/gUPAic0C7FTd1yYJhPx7WN0zOqTseDK3t/QnT6GGbzjS7idmjlKO63ujvUwzvf08Ty8eiXh80ZVzqoAAAFYSURBVDjLvZPXVsJAEIYpgST0DlIEFAQLFiw0KUGECKJIVECxvf9LaHZmMBG88/hdzX/mO7t7dnYNhv/FVciJYt5iWt015R37bqPRWFrb9rpW9AsOtQuUYuLSKrnYtRb3ulnfFwMDxnQ6hWLg0BmJQJ/Rm81mcyj765zm9Kke8D6ZTD7mUAc2vgVvF+iNZVketTGlFpuYI22gOy6X5ZGE6WCxRGJPAtpMaGGS4iSctBCJCVWKEdyDi1cJJjQoeSx4x5sNpPqoChWKni0SKgQTmpQOUeBCTYQJdzWKO7iFIVgjHlThlVI0iYL9nGBCnVKIRuqM1hEmPFGy0T1wwQsEBAxp52IW1vSQ8ayoQgfC0KYZt60DvCmK8oK1P6kR+MwVcP8FVGGr7kWZM5d6/MUfb5L3hW80CM7lZ23Nnt0CR8d2ftXH4E7tu4IgZH1F/ve/xZlMf/5fPwFR8XwfQCSWdQAAAABJRU5ErkJggg==" alt="iHeard.ai" width="24" height="24" style="object-fit: contain;" />
          <span class="button-text">${safeButtonText}</span>
        </button>

        <!-- Chat Window -->
        <div
          id="ai-chat-window"
          class="ai-chat-window"
          style="display: none;"
          role="dialog"
          aria-labelledby="ai-chat-title"
          aria-modal="true"
        >
          <!-- Chat Header with Animated Waves -->
          <div class="ai-chat-header">
            <!-- Animated wave layers -->
            <div class="header-waves">
              <div class="wave wave-1"></div>
              <div class="wave wave-2"></div>
              <div class="wave wave-3"></div>
            </div>

            <!-- Header content (above waves) -->
            <div class="chat-header-content">
              <div class="header-info">
                <h3 id="ai-chat-title">${safeChatTitle}</h3>
                <div class="header-status">
                  <span class="status-dot"></span>
                  <span class="status-text">${escapeHTML(widgetSettings.statusText || 'Online')}</span>
                </div>
              </div>
              <button
                class="ai-chat-close"
                id="ai-chat-close-btn"
                aria-label="${escapeHTML(widgetSettings.closeButtonLabel || 'Close')}"
                title="Close chat (Esc)"
              >
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Chat Messages Container -->
          <div class="ai-chat-messages-container">
            <!-- Chat Messages -->
            <div
              id="ai-chat-messages"
              class="ai-chat-messages"
              role="log"
              aria-live="polite"
              aria-atomic="false"
              aria-label="Chat messages"
            >
              <div class="ai-message assistant-message ai-welcome-message" style="margin-bottom: 16px !important; margin-top: 0px !important; display: block !important; max-width: 100% !important; width: 100% !important;">
                <div class="ai-welcome-screen" style="background: transparent; padding: 0;">
                  <!-- Welcome Header -->
                  <div class="welcome-header">
                    <div class="welcome-avatar">
                      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAABJlBMVEVHcEwb49o9s+I0v+BIoOUuyN9Ui+hZg+pdfOsc49tMl+ZViuke4NtOk+ce39sc4ts3t+Ej19xbf+pTi+gl1N1GoOVCp+RWh+kxwuAa5tpFo+Ue39s0vuAsyt4i2NxIneYpzd5Ml+Yry946suJUiuldfOs6suIc49oZ59oa5do/q+Neeusxwt8Y6dka5touxt88sOJcfupZgupcfuo0veBefOpcfuoZ5toiIiI8sOI2ueFCp+RFouVInuU5tOE/q+MzveAxwt8uxt9LmedQkOdWh+kry98o0N0hHx9Ui+gl1Nwi2dwf3dtOlOZZgulcfuomTFYsRFcrhZc+ZpxUjes4cJsyepkjP0Ei2t0lxs1ImOBPluomy9ZEcbFBo95KgMsmmaIkZ2ysswjsAAAAOHRSTlMA/gUPAic0C7FTd1yYJhPx7WN0zOqTseDK3t/QnT6GGbzjS7idmjlKO63ujvUwzvf08Ty8eiXh80ZVzqoAAAFYSURBVDjLvZPXVsJAEIYpgST0DlIEFAQLFiw0KUGECKJIVECxvf9LaHZmMBG88/hdzX/mO7t7dnYNhv/FVciJYt5iWt015R37bqPRWFrb9rpW9AsOtQuUYuLSKrnYtRb3ulnfFwMDxnQ6hWLg0BmJQJ/Rm81mcyj765zm9Kke8D6ZTD7mUAc2vgVvF+iNZVketTGlFpuYI22gOy6X5ZGE6WCxRGJPAtpMaGGS4iSctBCJCVWKEdyDi1cJJjQoeSx4x5sNpPqoChWKni0SKgQTmpQOUeBCTYQJdzWKO7iFIVgjHlThlVI0iYL9nGBCnVKIRuqM1hEmPFGy0T1wwQsEBAxp52IW1vSQ8ayoQgfC0KYZt60DvCmK8oK1P6kR+MwVcP8FVGGr7kWZM5d6/MUfb5L3hW80CM7lZ23Nnt0CR8d2ftXH4E7tu4IgZH1F/ve/xZlMf/5fPwFR8XwfQCSWdQAAAABJRU5ErkJggg==" alt="AI" width="32" height="32" />
                    </div>
                    <h2 class="welcome-title">${safeWelcomeMessage}</h2>
                  </div>

                  <!-- Product Discovery Section -->
                  <div class="quick-actions-section">
                    <div class="section-label">
                      <span>${escapeHTML(widgetSettings.sectionDiscoveryLabel || 'Product Discovery')}</span>
                    </div>
                    <div class="quick-actions-grid">
                      <button class="quick-action-btn" data-prompt="What are your best-selling products?">
                        <span class="quick-action-icon">üèÜ</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.bestSellersText || 'Best Sellers')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="Show me new arrivals">
                        <span class="quick-action-icon">‚ú®</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.newArrivalsText || 'New Arrivals')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="What products are on sale?">
                        <span class="quick-action-icon">üî•</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.onSaleText || 'On Sale')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="Show me recommendations for me">
                        <span class="quick-action-icon">üíé</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.recommendationsText || 'For You')}</span>
                      </button>
                    </div>
                  </div>

                  <!-- Customer Support Section -->
                  <div class="quick-actions-section">
                    <div class="section-label">
                      <span>${escapeHTML(widgetSettings.sectionSupportLabel || 'Customer Support')}</span>
                    </div>
                    <div class="quick-actions-grid">
                      <button class="quick-action-btn" data-prompt="Tell me about shipping and delivery">
                        <span class="quick-action-icon">üì¶</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.shippingText || 'Shipping Info')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="What is your return policy?">
                        <span class="quick-action-icon">‚Ü©Ô∏è</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.returnsText || 'Returns')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="How can I track my order?">
                        <span class="quick-action-icon">üîç</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.trackOrderText || 'Track Order')}</span>
                      </button>
                      <button class="quick-action-btn" data-prompt="I need help with something">
                        <span class="quick-action-icon">üí¨</span>
                        <span class="quick-action-text">${escapeHTML(widgetSettings.helpText || 'Help & FAQ')}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              

            </div>
          </div>
          
          <!-- Chat Input -->
          <div class="ai-chat-input">
            <div class="ai-chat-input-wrapper">
              <label for="ai-chat-input-field" class="sr-only">Type your message</label>
              <input
                type="text"
                id="ai-chat-input-field"
                placeholder="${safeInputPlaceholder}"
                aria-label="Type your message"
                aria-describedby="ai-powered-footer"
              />
              <button
                id="ai-chat-send-btn"
                aria-label="Send message"
                title="Send message (Enter)"
              >
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div id="ai-powered-footer" class="ai-powered-footer">Powered by AI</div>
          </div>
        </div>
      </div>
    `;
    
    // Add CSS styles
    addWidgetStyles();
    
    // Add event listeners after DOM is ready
    setTimeout(() => {
      setupEventListeners();
    }, 50);
  }
  
  // Add CSS styles for the widget
  function addWidgetStyles() {
    if (document.getElementById('ai-widget-styles')) return;

    // Set CSS variables for dynamic theming
    document.documentElement.style.setProperty('--ai-primary-color', widgetSettings.primaryColor);

    // Generate gradient colors from primary color
    const hexToRgb = (hex) => {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    };

    const rgb = hexToRgb(widgetSettings.primaryColor);
    if (rgb) {
      // Create darker shade for gradients
      const darkerR = Math.max(0, rgb.r - 40);
      const darkerG = Math.max(0, rgb.g - 40);
      const darkerB = Math.max(0, rgb.b - 40);
      const darkerColor = `rgb(${darkerR}, ${darkerG}, ${darkerB})`;
      document.documentElement.style.setProperty('--ai-primary-color-dark', darkerColor);
      document.documentElement.style.setProperty('--ai-primary-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
    }

    const style = document.createElement('style');
    style.id = 'ai-widget-styles';
    style.textContent = `
/* ‚ú® ACCESSIBILITY: Screen reader only class */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* üé® DESIGN SYSTEM: CSS Custom Properties */
.ai-sales-assistant-widget {
  /* === Typography Scale (Major Third: 1.25x) === */
  --font-size-xs: 0.64rem;    /* 10.24px */
  --font-size-sm: 0.8rem;     /* 12.8px */
  --font-size-base: 1rem;     /* 16px */
  --font-size-md: 1.25rem;    /* 20px */
  --font-size-lg: 1.563rem;   /* 25px */
  --font-size-xl: 1.953rem;   /* 31.25px */
  --font-size-2xl: 2.441rem;  /* 39px */

  /* === 8pt Grid Spacing System === */
  --space-1: 0.5rem;   /* 8px */
  --space-2: 1rem;     /* 16px */
  --space-3: 1.5rem;   /* 24px */
  --space-4: 2rem;     /* 32px */
  --space-5: 2.5rem;   /* 40px */
  --space-6: 3rem;     /* 48px */
  --space-7: 3.5rem;   /* 56px */
  --space-8: 4rem;     /* 64px */

  /* === Touch Targets (min 44px) === */
  --touch-target-min: 44px;
  --touch-target-comfortable: 48px;

  /* === Colors - Light Mode (WCAG AAA Compliant) === */
  --color-bg-primary: #ffffff;
  --color-bg-secondary: #f8f9fa;
  --color-bg-tertiary: #e9ecef;

  --color-text-primary: #1a1a1a;      /* 16.5:1 contrast on white */
  --color-text-secondary: #4a4a4a;    /* 10.4:1 contrast on white */
  --color-text-tertiary: #6c6c6c;     /* 7.5:1 contrast (AA Large) */

  --color-border-light: #e5e7eb;
  --color-border-medium: #d1d5db;
  --color-border-strong: #9ca3af;

  /* === Focus States === */
  --focus-ring-color: #3b82f6;
  --focus-ring-width: 3px;
  --focus-ring-offset: 2px;
  --focus-ring: 0 0 0 var(--focus-ring-offset) var(--color-bg-primary),
                0 0 0 calc(var(--focus-ring-offset) + var(--focus-ring-width)) var(--focus-ring-color);

  /* === Transitions === */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);

  /* === Shadows === */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);

  /* === Border Radius === */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-full: 9999px;

  /* === Base Styles === */
  position: fixed;
  z-index: 1000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: var(--font-size-base);
  color: var(--color-text-primary);
}

/* üåô DARK MODE: Automatic Detection */
@media (prefers-color-scheme: dark) {
  .ai-sales-assistant-widget:not(.force-light-mode) {
    /* === Colors - Dark Mode (WCAG AAA Compliant) === */
    --color-bg-primary: #1a1a1a;
    --color-bg-secondary: #2d2d2d;
    --color-bg-tertiary: #404040;

    --color-text-primary: #f5f5f5;      /* 15.8:1 contrast on dark */
    --color-text-secondary: #d4d4d4;    /* 11.5:1 contrast on dark */
    --color-text-tertiary: #a3a3a3;     /* 7.2:1 contrast (AA Large) */

    --color-border-light: #404040;
    --color-border-medium: #525252;
    --color-border-strong: #737373;

    --focus-ring-color: #60a5fa;
  }

  .ai-chat-window:not(.force-light-mode) {
    background: rgba(26, 26, 26, 0.98) !important;
    border-color: rgba(64, 64, 64, 0.5) !important;
  }

  .ai-chat-messages:not(.force-light-mode) {
    background-color: var(--color-bg-primary) !important;
  }

  .user-message:not(.force-light-mode) {
    background: var(--color-bg-tertiary) !important;
    color: var(--color-text-primary) !important;
  }

  .assistant-message:not(.force-light-mode) .message-content {
    background: var(--color-bg-secondary) !important;
    color: var(--color-text-primary) !important;
  }
}

/* Position variants */
.ai-sales-assistant-widget.position-bottom-right {
  bottom: 20px;
  right: 20px;
}

.ai-sales-assistant-widget.position-bottom-left {
  bottom: 20px;
  left: 20px;
}

.ai-sales-assistant-widget.position-top-right {
  top: 20px;
  right: 20px;
}

.ai-sales-assistant-widget.position-top-left {
  top: 20px;
  left: 20px;
}

.ai-sales-assistant-widget.position-center-right {
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
}

.ai-sales-assistant-widget.position-center-left {
  top: 50%;
  left: 20px;
  transform: translateY(-50%);
}

/* üéØ ENHANCED: Modern Toggle Button with Proper Touch Targets */
.ai-chat-toggle {
  /* Touch Target: 48px minimum */
  min-width: var(--touch-target-comfortable);
  min-height: var(--touch-target-comfortable);

  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  border: none;
  border-radius: var(--radius-full);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-1);
  padding: var(--space-2) var(--space-3);
  font-size: var(--font-size-base);
  font-weight: 600;
  box-shadow: var(--shadow-lg),
    0 4px 15px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.4);
  transition: all var(--transition-smooth);
  position: relative;
  overflow: hidden;
  animation: floatButton 3s ease-in-out infinite;
}

/* ‚ú® ACCESSIBILITY: Focus States */
.ai-chat-toggle:focus {
  outline: none;
  box-shadow: var(--focus-ring),
    0 4px 15px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.4);
}

.ai-chat-toggle:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring),
    var(--shadow-xl),
    0 4px 15px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.5);
}

.ai-chat-toggle::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.5s;
}

.ai-chat-toggle:hover::before {
  left: 100%;
}

.ai-chat-toggle:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow:
    0 6px 20px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.5),
    0 15px 35px rgba(0, 0, 0, 0.2);
}

.ai-chat-toggle:active {
  transform: translateY(-1px) scale(0.98);
}

.ai-chat-toggle .button-text {
  white-space: nowrap;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* Floating Animation */
@keyframes floatButton {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

/* Modern Chat Window with Glassmorphism */
.ai-chat-window {
  position: absolute;
  bottom: 80px;
  right: 0;
  width: 400px;
  height: 600px;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow:
    0 8px 32px rgba(0, 0, 0, 0.1),
    0 20px 60px rgba(0, 0, 0, 0.15),
    0 0 0 1px rgba(255, 255, 255, 0.1) inset;
  display: none;
  grid-template-rows: 70px 1fr 80px;
  grid-template-areas:
    "header"
    "messages"
    "input";
  overflow: hidden;
  max-height: 600px;
  min-height: 600px;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(20px) scale(0.95);
  transition:
    opacity 0.3s var(--transition-smooth),
    visibility 0.3s var(--transition-smooth),
    transform 0.3s var(--transition-bounce);
}

.ai-chat-window.ai-chat-open {
  display: grid !important;
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
  transform: translateY(0) scale(1);
}

.ai-sales-assistant-widget.position-bottom-left .ai-chat-window,
.ai-sales-assistant-widget.position-top-left .ai-chat-window,
.ai-sales-assistant-widget.position-center-left .ai-chat-window {
  right: auto;
  left: 0;
}

.ai-sales-assistant-widget.position-top-right .ai-chat-window,
.ai-sales-assistant-widget.position-top-left .ai-chat-window {
  bottom: auto;
  top: 70px;
}

.ai-sales-assistant-widget.position-center-right .ai-chat-window,
.ai-sales-assistant-widget.position-center-left .ai-chat-window {
  bottom: auto;
  top: 50%;
  transform: translateY(-50%);
}

/* üåä PART 1: Animated Wave Effect Header */
.ai-chat-header {
  position: relative;
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  color: white;
  padding: 20px;
  z-index: 10;
  height: 70px;
  box-sizing: border-box;
  grid-area: header !important;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.3);
}

/* Wave layers container */
.header-waves {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: 0;
  pointer-events: none;
}

/* Individual wave styling */
.wave {
  position: absolute;
  bottom: -10px;
  left: 0;
  width: 200%;
  height: 100%;
  background-repeat: repeat-x;
  background-position: 0 bottom;
  transform-origin: center bottom;
}

/* Wave 1 - Background layer */
.wave-1 {
  background-size: 50% 80px;
  animation: wave-animation-1 15s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
  opacity: 0.15;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z' opacity='.25' fill='%23ffffff'/%3E%3Cpath d='M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z' opacity='.5' fill='%23ffffff'/%3E%3Cpath d='M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z' fill='%23ffffff'/%3E%3C/svg%3E");
}

/* Wave 2 - Middle layer */
.wave-2 {
  background-size: 50% 100px;
  animation: wave-animation-2 20s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
  opacity: 0.2;
  animation-delay: -5s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' opacity='.25' fill='%23ffffff'/%3E%3Cpath d='M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z' opacity='.5' fill='%23ffffff'/%3E%3Cpath d='M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z' fill='%23ffffff'/%3E%3C/svg%3E");
}

/* Wave 3 - Foreground layer */
.wave-3 {
  background-size: 50% 120px;
  animation: wave-animation-3 25s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
  opacity: 0.3;
  animation-delay: -10s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M985.66,92.83C906.67,72,823.78,31,743.84,14.19c-82.26-17.34-168.06-16.33-250.45.39-57.84,11.73-114,31.07-172,41.86A600.21,600.21,0,0,1,0,27.35V120H1200V95.8C1132.19,118.92,1055.71,111.31,985.66,92.83Z' opacity='.25' fill='%23ffffff'/%3E%3Cpath d='M1200,0H0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z' opacity='.5' fill='%23ffffff'/%3E%3Cpath d='M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z' fill='%23ffffff'/%3E%3C/svg%3E");
}

/* Wave animations */
@keyframes wave-animation-1 {
  0% { transform: translateX(0) translateZ(0) scaleY(1); }
  50% { transform: translateX(-25%) translateZ(0) scaleY(0.95); }
  100% { transform: translateX(-50%) translateZ(0) scaleY(1); }
}

@keyframes wave-animation-2 {
  0% { transform: translateX(0) translateZ(0) scaleY(1); }
  50% { transform: translateX(-25%) translateZ(0) scaleY(1.05); }
  100% { transform: translateX(-50%) translateZ(0) scaleY(1); }
}

@keyframes wave-animation-3 {
  0% { transform: translateX(0) translateZ(0) scaleY(1); }
  50% { transform: translateX(-25%) translateZ(0) scaleY(0.98); }
  100% { transform: translateX(-50%) translateZ(0) scaleY(1); }
}

/* Ensure header content stays above waves */
.chat-header-content {
  position: relative;
  z-index: 2;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Header info section */
.header-info {
  flex: 1;
}

.header-info h3 {
  margin: 0 0 4px 0;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.3px;
}

/* Header status */
.header-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  opacity: 0.95;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #4ade80;
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(74, 222, 128, 0.8);
  animation: pulse 2s ease-in-out infinite;
}

.status-text {
  font-size: 13px;
  font-weight: 500;
}

/* Pulsing Online Status Dot */
@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.7;
    transform: scale(1.1);
  }
}

/* Reduce motion for accessibility */
@media (prefers-reduced-motion: reduce) {
  .wave {
    animation: none;
  }
  .status-dot {
    animation: none;
  }
}

/* üéØ ENHANCED: Close Button with Touch Target & Focus State */
.ai-chat-close {
  /* Touch Target: 44px minimum */
  min-width: var(--touch-target-min);
  min-height: var(--touch-target-min);

  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  cursor: pointer;
  padding: var(--space-1);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-smooth);
}

.ai-chat-close:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5),
              0 0 0 4px rgba(255, 255, 255, 0.3);
}

.ai-chat-close:focus-visible {
  outline: none;
  background: rgba(255, 255, 255, 0.35);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.6),
              0 0 0 5px rgba(255, 255, 255, 0.4);
}

.ai-chat-close svg {
  width: 20px;
  height: 20px;
  transition: transform var(--transition-smooth);
}

.ai-chat-close:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.05);
}

.ai-chat-close:hover svg {
  transform: rotate(90deg);
}

.ai-chat-close:active {
  transform: scale(0.95);
}

.ai-chat-messages-container {
  grid-area: messages !important;
  overflow: hidden;
  background: #fafafa;
  box-sizing: border-box;
  height: 100%;
  width: 100%;
}

.ai-chat-messages {
  padding: 15px;
  padding-bottom: 15px; /* Consistent padding */
  overflow-y: auto !important; /* Show scrollbar when content overflows */
  overflow-x: hidden !important;
  display: flex;
  flex-direction: column;
  gap: 0 !important; /* Remove gap to use margin instead for better control */
  scroll-behavior: smooth;
  height: 100% !important; /* Take full available height */
  box-sizing: border-box !important;
  background: #fafafa; /* Light background to distinguish from header/footer */
}

/* Modern Custom Scrollbar */
.ai-chat-messages::-webkit-scrollbar {
  width: 6px;
}

.ai-chat-messages::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.03);
  border-radius: 10px;
  margin: 4px 0;
}

.ai-chat-messages::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  border-radius: 10px;
  transition: all 0.3s ease;
}

.ai-chat-messages::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--ai-primary-color-dark, #cc00cc) 0%, var(--ai-primary-color, #ee5cee) 100%);
  width: 8px;
}

/* Firefox scrollbar */
.ai-chat-messages {
  scrollbar-width: thin;
  scrollbar-color: var(--ai-primary-color, #ee5cee) rgba(0, 0, 0, 0.03);
}

#ai-chat-messages .ai-message,
.ai-chat-messages .ai-message,
.ai-chat-messages-container .ai-message {
  max-width: 85% !important;
  width: fit-content;
  overflow: visible !important; /* Allow content to show fully */
  display: block !important;
  box-sizing: border-box !important;
  margin-bottom: 16px !important; /* Increased spacing for better visibility */
  margin-top: 0 !important; /* Reset any top margins */
}

/* Welcome screen should take full width */
.ai-welcome-message {
  max-width: 100% !important;
  width: 100% !important;
}

#ai-chat-messages .ai-message:last-child,
.ai-chat-messages .ai-message:last-child,
.ai-chat-messages-container .ai-message:last-child {
  margin-bottom: 8px !important; /* Small bottom margin for last message */
}

/* Force spacing with even higher specificity */
.ai-sales-assistant-widget .ai-chat-messages .ai-message {
  margin-bottom: 16px !important;
  margin-top: 0 !important;
}

.ai-message.user-message {
  align-self: flex-end;
}

.ai-message.assistant-message {
  align-self: flex-start;
}

.ai-message.product-recommendation {
  margin-top: 0 !important; /* Use consistent margin pattern */
  margin-bottom: 12px !important; /* Consistent with other messages */
}

.product-content {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.clickable-product {
  user-select: none;
}

.clickable-product:active {
  transform: scale(0.98) !important;
}

/* Enhanced Messages with Gradients and Animations */
.message-content {
  padding: 12px 16px;
  font-size: 14.5px;
  line-height: 1.5;
  word-wrap: break-word !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  hyphens: auto;
  max-width: 100% !important;
  white-space: normal !important;
  box-sizing: border-box !important;
  overflow: visible !important;
  position: relative;
  animation: slideIn 0.4s var(--transition-smooth);
}

/* Slide-in Animation */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* User Message - Gradient Background with Asymmetric Border Radius */
.user-message .message-content {
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  color: white;
  border-radius: 20px 20px 4px 20px;
  box-shadow: 0 2px 10px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.3);
  margin-left: auto;
}

/* AI Message - Clean White Bubble with Asymmetric Border Radius */
.assistant-message .message-content {
  background: white;
  color: #1f2937;
  border-radius: 20px 20px 20px 4px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.ai-loading {
  padding: 10px 14px;
  border-radius: 18px;
  background: #f1f1f1;
  color: #333;
  margin-bottom: 16px !important; /* Match message spacing */
  margin-top: 0 !important;
  max-width: 85% !important;
  width: fit-content;
  align-self: flex-start; /* Left-align like assistant messages */
  display: block !important;
  box-sizing: border-box !important;
}

.loading-dots {
  display: inline-flex;
  gap: 4px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--ai-primary-color, #ee5cee);
  animation: loading-bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes loading-bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Modern Input Area with Gradient Send Button */
.ai-chat-input {
  padding: 16px 20px 12px 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.08);
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: rgba(255, 255, 255, 0.95) !important;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 10;
  height: 80px !important;
  box-sizing: border-box !important;
  border-radius: 0 0 20px 20px;
  grid-area: input !important;
}

.ai-chat-input-wrapper {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* üéØ ENHANCED: Input Field with WCAG AAA Compliant Colors */
.ai-chat-input input {
  flex: 1;
  min-height: var(--touch-target-min);
  padding: var(--space-2) var(--space-3);
  border: 2px solid var(--color-border-medium);
  border-radius: var(--radius-full);
  font-size: var(--font-size-base);
  color: var(--color-text-primary);
  outline: none;
  transition: all var(--transition-smooth);
  background: var(--color-bg-primary);
  font-family: inherit;
}

/* ‚ú® ACCESSIBILITY: Input Focus States */
.ai-chat-input input:focus {
  outline: none;
  border-color: var(--ai-primary-color, #ee5cee);
  box-shadow: 0 0 0 3px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.15);
}

.ai-chat-input input:focus-visible {
  outline: none;
  border-color: var(--ai-primary-color, #ee5cee);
  box-shadow: 0 0 0 2px var(--color-bg-primary),
              0 0 0 5px var(--ai-primary-color, #ee5cee);
}

.ai-chat-input input::placeholder {
  color: var(--color-text-tertiary);
}

/* üéØ ENHANCED: Send Button with Touch Target & Focus State */
.ai-chat-input button {
  /* Touch Target: 48px */
  min-width: var(--touch-target-comfortable);
  min-height: var(--touch-target-comfortable);
  width: var(--touch-target-comfortable);
  height: var(--touch-target-comfortable);

  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-smooth);
  box-shadow: var(--shadow-md),
    0 4px 12px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.4);
  flex-shrink: 0;
}

/* ‚ú® ACCESSIBILITY: Send Button Focus States */
.ai-chat-input button:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--color-bg-primary),
              0 0 0 5px var(--ai-primary-color, #ee5cee),
              0 4px 12px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.4);
}

.ai-chat-input button:focus-visible {
  outline: none;
  box-shadow: 0 0 0 2px var(--color-bg-primary),
              0 0 0 6px var(--ai-primary-color, #ee5cee),
              var(--shadow-lg);
}

.ai-chat-input button:hover {
  transform: scale(1.08);
  box-shadow: var(--shadow-lg),
    0 6px 16px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.5);
}

.ai-chat-input button:active {
  transform: scale(0.95);
}

/* Powered by AI Footer */
.ai-powered-footer {
  text-align: center;
  font-size: var(--font-size-xs);
  color: var(--color-text-tertiary);
  font-weight: 500;
  letter-spacing: 0.5px;
  padding: 0;
  margin: 0;
}

.ai-powered-footer::before {
  content: '‚ú® ';
}

/* üíÄ SKELETON LOADING STATES */
.skeleton {
  background: linear-gradient(
    90deg,
    var(--color-bg-secondary) 0%,
    var(--color-bg-tertiary) 50%,
    var(--color-bg-secondary) 100%
  );
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-message {
  padding: var(--space-2) var(--space-3);
  margin-bottom: var(--space-2);
  border-radius: var(--radius-lg);
  max-width: 80%;
}

.skeleton-line {
  height: 16px;
  margin-bottom: var(--space-1);
}

.skeleton-line:last-child {
  width: 60%;
  margin-bottom: 0;
}

.skeleton-product-card {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border-light);
  border-radius: var(--radius-lg);
  overflow: hidden;
  padding: 0;
}

.skeleton-product-image {
  width: 100%;
  height: 180px;
  background: var(--color-bg-secondary);
}

.skeleton-product-content {
  padding: var(--space-2);
}

.skeleton-product-title {
  height: 20px;
  width: 80%;
  margin-bottom: var(--space-2);
}

.skeleton-product-price {
  height: 24px;
  width: 40%;
  margin-bottom: var(--space-1);
}

.skeleton-product-description {
  height: 14px;
  width: 100%;
  margin-bottom: var(--space-1);
}

/* üéØ ENHANCED: Suggestion Buttons with Touch Targets */
.suggestion-btn {
  /* Touch Target: 44px minimum */
  min-height: var(--touch-target-min);

  background: var(--color-bg-primary);
  border: 2px solid var(--color-border-medium);
  color: var(--color-text-primary);
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-full);
  font-size: var(--font-size-sm);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-smooth);
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* ‚ú® ACCESSIBILITY: Suggestion Button Focus States */
.suggestion-btn:focus {
  outline: none;
  border-color: var(--ai-primary-color, #ee5cee);
  box-shadow: 0 0 0 3px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.15);
}

.suggestion-btn:focus-visible {
  outline: none;
  border-color: var(--ai-primary-color, #ee5cee);
  box-shadow: 0 0 0 2px var(--color-bg-primary),
              0 0 0 5px var(--ai-primary-color, #ee5cee);
}

.suggestion-btn:hover {
  background: var(--ai-primary-color, #ee5cee);
  color: white;
  border-color: var(--ai-primary-color, #ee5cee);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.suggestion-btn:active {
  transform: translateY(0);
}

/* Mobile responsiveness */
/* Modern Product Grid Styles */
.products-grid-container {
  max-width: 100% !important;
  width: 100% !important;
}

.products-grid {
  display: grid;
  gap: 14px;
  width: 100%;
}

/* Modern Product Cards with Enhanced Shadows */
.product-card {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.4s var(--transition-smooth);
  box-shadow:
    0 2px 8px rgba(0, 0, 0, 0.06),
    0 4px 16px rgba(0, 0, 0, 0.04);
  display: flex;
  flex-direction: column;
  height: 100%;
  cursor: pointer;
}

.product-card:hover {
  transform: translateY(-6px) scale(1.01);
  box-shadow:
    0 8px 20px rgba(0, 0, 0, 0.1),
    0 16px 40px rgba(0, 0, 0, 0.08),
    0 0 0 1px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.1);
  border-color: rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.2);
}

/* Product Image with Subtle Gradient Overlay */
.product-image {
  width: 100%;
  height: 180px;
  background-size: cover;
  background-position: center;
  background-color: #f8f9fa;
  position: relative;
  flex-shrink: 0;
}

.product-image::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 50%;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.15), transparent);
  pointer-events: none;
}

.product-details {
  padding: 16px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.product-title {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price-category {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

/* Gradient Text for Prices */
.product-price {
  font-size: 22px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.product-category {
  background: #f3f4f6;
  color: #6b7280;
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 500;
}

.product-description {
  margin: 0 0 12px 0;
  font-size: 13px;
  color: #6b7280;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  flex-grow: 1;
}

.product-tags {
  margin-bottom: 12px;
}

.product-tag {
  display: inline-block;
  background: #e5e7eb;
  color: #374151;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 10px;
  margin-right: 4px;
  margin-bottom: 4px;
}

/* Gradient CTA Button with Arrow Icon */
.product-action-button {
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  color: white;
  text-align: center;
  padding: 12px;
  border-radius: 12px;
  font-size: 14.5px;
  font-weight: 700;
  margin-top: auto;
  transition: all 0.3s var(--transition-smooth);
  box-shadow: 0 2px 8px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  letter-spacing: 0.3px;
}

.product-action-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.4);
}

.product-action-button:active {
  transform: translateY(0);
}

/* Glassmorphic Relevance Badge */
.relevance-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1;
  letter-spacing: 0.3px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* AI Welcome Interface Styles - Modern Design */
.ai-welcome-container {
  width: 100%;
  max-width: none !important;
}

/* üéØ PART 2: Modern Welcome Screen Redesign */
.ai-welcome-screen {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Welcome Header */
.welcome-header {
  text-align: center;
  margin-bottom: 0;
}

.welcome-avatar {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  box-shadow:
    0 8px 16px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.2),
    0 4px 8px rgba(0, 0, 0, 0.1);
  animation: floatAvatar 3s ease-in-out infinite;
}

@keyframes floatAvatar {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-8px) rotate(2deg); }
}

.welcome-avatar img {
  width: 32px;
  height: 32px;
  filter: brightness(0) invert(1);
}

.welcome-title {
  font-size: 17px;
  font-weight: 700;
  color: #111827;
  margin: 0;
  line-height: 1.4;
}

/* Quick Actions Section */
.quick-actions-section {
  margin-bottom: 8px;
}

.section-label {
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-label::before {
  content: '';
  width: 3px;
  height: 12px;
  background: var(--ai-primary-color, #ee5cee);
  border-radius: 2px;
}

/* Modern Quick Action Buttons - COMPACT PILLS */
.quick-actions-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.quick-action-btn {
  background: white;
  border: 1.5px solid #e5e7eb;
  border-radius: 12px;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13.5px;
  font-weight: 500;
  color: #4b5563;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  text-align: left;
  line-height: 1.3;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
}

/* Gradient overlay on hover */
.quick-action-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--ai-primary-color, #ee5cee) 0%, var(--ai-primary-color-dark, #cc00cc) 100%);
  opacity: 0;
  transition: opacity 0.25s ease;
  z-index: 0;
}

.quick-action-btn:hover::before {
  opacity: 0.06;
}

.quick-action-btn:hover {
  border-color: var(--ai-primary-color, #ee5cee);
  transform: translateY(-2px);
  box-shadow:
    0 4px 12px rgba(var(--ai-primary-color-rgb, 238, 92, 238), 0.15),
    0 2px 4px rgba(0, 0, 0, 0.08);
}

.quick-action-btn:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

/* Icon styling */
.quick-action-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  position: relative;
  z-index: 1;
  transition: transform 0.25s ease;
}

.quick-action-btn:hover .quick-action-icon {
  transform: scale(1.1);
}

/* Text styling */
.quick-action-text {
  flex: 1;
  position: relative;
  z-index: 1;
  transition: color 0.25s ease;
}

.quick-action-btn:hover .quick-action-text {
  color: #111827;
}

/* Responsive Design - Mobile (‚â§480px) */
@media (max-width: 480px) {
  .ai-chat-window {
    width: calc(100vw - 32px);
    height: calc(100vh - 120px);
    max-height: calc(100vh - 120px);
    position: fixed;
    bottom: 80px;
    left: 16px;
    right: 16px;
  }

  .ai-sales-assistant-widget.position-bottom-left .ai-chat-window,
  .ai-sales-assistant-widget.position-top-left .ai-chat-window,
  .ai-sales-assistant-widget.position-center-left .ai-chat-window,
  .ai-sales-assistant-widget.position-bottom-right .ai-chat-window,
  .ai-sales-assistant-widget.position-top-right .ai-chat-window,
  .ai-sales-assistant-widget.position-center-right .ai-chat-window {
    left: 16px;
    right: 16px;
    transform: none;
  }

  .ai-chat-toggle {
    padding: 12px 16px;
  }

  .ai-chat-toggle .button-text {
    display: none;
  }

  .ai-chat-header {
    padding: 16px;
    height: 60px;
  }

  .header-info h3 {
    font-size: 16px;
  }

  .ai-message {
    max-width: 90%;
  }

  .message-content {
    font-size: 14px;
    padding: 10px 14px;
  }

  /* Mobile Welcome Screen */
  .ai-welcome-screen {
    padding: 20px;
    gap: 20px;
  }

  .quick-actions-grid {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .quick-action-btn {
    padding: 12px 14px;
  }

  .welcome-title {
    font-size: 16px;
  }

  .ai-chat-input {
    padding: 14px 16px 10px 16px;
    height: 75px !important;
  }

  .ai-chat-input input {
    padding: 12px 16px;
    font-size: 14px;
  }

  .ai-chat-input button {
    width: 42px;
    height: 42px;
  }

  .suggestion-btn {
    font-size: 13.5px;
    padding: 12px 16px;
  }

  .ai-welcome-header h3 {
    font-size: 17px;
  }

  .ai-avatar-container {
    width: 56px !important;
    height: 56px !important;
  }
  
  /* Mobile Product Grid Styles */
  .products-grid {
    grid-template-columns: 1fr !important; /* Single column on mobile */
    gap: 10px;
  }
  
  .product-card {
    flex-direction: row; /* Horizontal layout on mobile */
    height: auto;
    min-height: 120px;
  }
  
  .product-image {
    width: 100px;
    height: 120px;
    flex-shrink: 0;
  }
  
  .product-details {
    padding: 12px;
    flex-grow: 1;
  }
  
  .product-title {
    font-size: 14px;
    -webkit-line-clamp: 1;
    margin-bottom: 6px;
  }
  
  .product-price {
    font-size: 16px;
  }
  
  .product-description {
    font-size: 12px;
    -webkit-line-clamp: 2;
    margin-bottom: 8px;
  }
  
  .product-action-button {
    padding: 8px;
    font-size: 12px;
  }
  
  .relevance-badge {
    top: 4px;
    right: 4px;
    padding: 2px 6px;
    font-size: 10px;
  }
  
  .product-category {
    font-size: 10px;
    padding: 1px 6px;
  }
  
  .product-tag {
    font-size: 9px;
    padding: 1px 4px;
  }
}

/* Responsive Design - Tablet (481px - 768px) */
@media (max-width: 768px) and (min-width: 481px) {
  .ai-chat-window {
    width: 380px;
    height: 580px;
    max-height: 580px;
  }

  .products-grid {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
    gap: 12px;
  }

  .product-image {
    height: 160px;
  }

  .product-title {
    font-size: 15.5px;
  }

  .product-price {
    font-size: 20px;
  }

  .ai-chat-input input {
    font-size: 14px;
  }

  .suggestion-btn {
    font-size: 14px;
  }
}

/* Responsive Design - Desktop Large (>1024px) */
@media (min-width: 1025px) {
  .ai-chat-window {
    width: 400px;
    height: 600px;
  }
}
    `;
    document.head.appendChild(style);
  }
  
  // Setup event listeners for widget buttons
  function setupEventListeners() {
    console.log('üîß AI Widget: Setting up event listeners');
    
    // Store references to event handlers so we can remove them if needed
    window.aiWidgetHandlers = window.aiWidgetHandlers || {};
    
    // Toggle button event listener
    const toggleBtn = document.getElementById('ai-chat-toggle-btn');
    if (toggleBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.toggleHandler) {
        toggleBtn.removeEventListener('click', window.aiWidgetHandlers.toggleHandler);
      }
      
      window.aiWidgetHandlers.toggleHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è AI Widget: Toggle button clicked');
        toggleAIChat();
      };
      
      toggleBtn.addEventListener('click', window.aiWidgetHandlers.toggleHandler);
      console.log('‚úÖ AI Widget: Toggle button event listener added');
    } else {
      console.warn('‚ö†Ô∏è AI Widget: Toggle button not found');
    }
    
    // Close button event listener
    const closeBtn = document.getElementById('ai-chat-close-btn');
    if (closeBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.closeHandler) {
        closeBtn.removeEventListener('click', window.aiWidgetHandlers.closeHandler);
      }
      
      window.aiWidgetHandlers.closeHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è AI Widget: Close button clicked');
        toggleAIChat();
      };
      
      closeBtn.addEventListener('click', window.aiWidgetHandlers.closeHandler);
      console.log('‚úÖ AI Widget: Close button event listener added');
    } else {
      console.warn('‚ö†Ô∏è AI Widget: Close button not found');
    }
    
    // Send button event listener
    const sendBtn = document.getElementById('ai-chat-send-btn');
    if (sendBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.sendHandler) {
        sendBtn.removeEventListener('click', window.aiWidgetHandlers.sendHandler);
      }
      
      window.aiWidgetHandlers.sendHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        sendAIMessage();
      };
      
      sendBtn.addEventListener('click', window.aiWidgetHandlers.sendHandler);
      console.log('‚úÖ AI Widget: Send button event listener added');
    } else {
      console.warn('‚ö†Ô∏è AI Widget: Send button not found');
    }
    
    // Input field event listener for Enter key
    const inputField = document.getElementById('ai-chat-input-field');
    if (inputField) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.keyHandler) {
        inputField.removeEventListener('keypress', window.aiWidgetHandlers.keyHandler);
      }
      
      window.aiWidgetHandlers.keyHandler = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendAIMessage();
        }
      };
      
      inputField.addEventListener('keypress', window.aiWidgetHandlers.keyHandler);
      console.log('‚úÖ AI Widget: Input field event listener added');
    } else {
      console.warn('‚ö†Ô∏è AI Widget: Input field not found');
    }

    // ‚ú® ACCESSIBILITY: Escape key handler to close chat
    window.aiWidgetHandlers.escapeHandler = function(e) {
      if (e.key === 'Escape' && chatOpen) {
        e.preventDefault();
        toggleAIChat();
      }
    };
    document.addEventListener('keydown', window.aiWidgetHandlers.escapeHandler);
    console.log('‚úÖ AI Widget: Escape key handler added');

    // ‚ú® ACCESSIBILITY: Focus trap for dialog
    window.aiWidgetHandlers.focusTrapHandler = function(e) {
      if (!chatOpen) return;

      const chatWindow = document.getElementById('ai-chat-window');
      if (!chatWindow) return;

      const focusableElements = chatWindow.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      // Tab key pressed
      if (e.key === 'Tab') {
        // Shift + Tab: focus last element if at first
        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        }
        // Tab: focus first element if at last
        else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    };
    document.addEventListener('keydown', window.aiWidgetHandlers.focusTrapHandler);
    console.log('‚úÖ AI Widget: Focus trap handler added');

    // Add suggestion button event listeners (both old and new styles)
    const suggestionBtns = document.querySelectorAll('.suggestion-btn, .quick-action-btn');
    suggestionBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const prompt = this.getAttribute('data-prompt');
        if (prompt) {
          console.log('üñ±Ô∏è AI Widget: Quick action clicked:', prompt);
          // Auto-fill input and send message
          const inputField = document.getElementById('ai-chat-input-field');
          if (inputField) {
            inputField.value = prompt;
            sendAIMessage();
          }
        }
      });
    });
    console.log('‚úÖ AI Widget: Suggestion button listeners added:', suggestionBtns.length);
    
    // Add click outside to close functionality (only add once)
    if (!window.aiWidgetHandlers.outsideClickHandler) {
      window.aiWidgetHandlers.outsideClickHandler = function(e) {
        const chatWindow = document.getElementById('ai-chat-window');
        const widget = document.querySelector('.ai-sales-assistant-widget');
        
        if (chatOpen && chatWindow && widget && !widget.contains(e.target)) {
          console.log('üñ±Ô∏è AI Widget: Clicked outside, closing chat');
          toggleAIChat();
        }
      };
      
      document.addEventListener('click', window.aiWidgetHandlers.outsideClickHandler);
      console.log('‚úÖ AI Widget: Outside click listener added');
    }
  }
  
  // Add manual refresh function for debugging
  window.refreshAIWidget = async function() {
    console.log('üîÑ AI Widget: Manual refresh triggered');
    await initializeWidget();
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWidget);
  } else {
    initializeWidget();
  }
  
  // ‚úÖ MEMORY: Check for setting updates every 5 minutes with proper cleanup
  let workingApiUrl = null; // Cache the working URL to avoid testing all URLs every time

  settingsCheckInterval = setInterval(async () => {
    try {
      const shopDomain = window.Shopify?.shop || '{{ shop.permanent_domain }}';
      const urlsToTry = workingApiUrl ? [workingApiUrl] : [
        // Use app proxy URL - properly forwarded to your app server
        '{{ shop.url }}' + '/apps/widget-settings',
        // Fallback to current host
        window.location.protocol + '//' + window.location.host + '/apps/widget-settings'
      ];

      for (const url of urlsToTry) {
        try {
          const response = await fetchWithRetry(`${url}?shop=${shopDomain}&t=${Date.now()}`, {}, 1);
          const data = await response.json();
          const currentUpdate = data.settings.updatedAt;

          // Cache the working URL
          if (!workingApiUrl) workingApiUrl = url;

          if (window.lastSettingsUpdate && currentUpdate !== window.lastSettingsUpdate) {
            console.log('üîÑ AI Widget: Settings updated, refreshing widget...', {
              old: window.lastSettingsUpdate,
              new: currentUpdate,
              newSettings: data.settings
            });
            widgetSettings = { ...blockSettings, ...data.settings };
            createWidget();
            console.log('‚úÖ AI Widget: Widget refreshed with new settings');
          }
          window.lastSettingsUpdate = currentUpdate;
          break; // Success, stop trying other URLs
        } catch (e) {
          // If the cached URL fails, reset it to try all URLs next time
          if (url === workingApiUrl) workingApiUrl = null;
          continue;
        }
      }
    } catch (e) {
      // Silently fail
    }
  }, 300000); // 5 minutes (300,000ms) - much more reasonable for production
})();
</script> 