generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model WidgetSettings {
  id               String       @id @default(cuid())
  shop             String       @unique
  enabled          Boolean      @default(true)
  position         String       @default("bottom-right")
  buttonText       String       @default("Ask AI Assistant")
  chatTitle        String       @default("AI Sales Assistant")
  welcomeMessage   String       @default("Hello! I'm your AI sales assistant. I can help you find products, answer questions about pricing, shipping, and provide personalized recommendations. How can I assist you today?")
  inputPlaceholder String       @default("Ask me anything about our products...")
  primaryColor     String       @default("#ee5cee")
  webhookUrl       String?
  interfaceLanguage String      @default("en")
  plan             String       @default("BASIC")
  openaiApiKey     String?
  apiKeyLastTested DateTime?
  apiKeyLastUpdated DateTime?
  apiKeyStatus     String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  workflowType     WorkflowType @default(DEFAULT)

  // Rating modal customization
  ratingEnabled       Boolean  @default(true)
  ratingCustomTitle   String?
  ratingCustomThankYou String?
}

model ProductEmbedding {
  id             String   @id @default(cuid())
  shop           String
  productId      String
  productHandle  String
  title          String
  description    String?
  embedding      String
  embeddingModel String   @default("text-embedding-3-small")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([shop, productId])
  @@index([shop, productHandle])
}

model UserProfile {
  id              String        @id @default(cuid())
  shop            String
  customerId      String?
  sessionId       String
  preferences     String        @default("{}")
  browsingHistory String        @default("[]")
  purchaseHistory String        @default("[]")
  interactions    String        @default("[]")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  chatSessions    ChatSession[]

  @@unique([shop, sessionId])
  @@index([shop, customerId])
  @@index([shop, updatedAt])
}

model ChatSession {
  id            String        @id @default(cuid())
  shop          String
  userProfileId String
  context       String        @default("{}")
  lastMessageAt DateTime      @default(now())
  createdAt     DateTime      @default(now())
  rating        Int?
  ratingComment String?
  ratedAt       DateTime?
  messages      ChatMessage[]
  userProfile   UserProfile   @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([shop, userProfileId])
  @@index([shop, lastMessageAt])
  @@index([shop, ratedAt])
}

model ChatMessage {
  id             String      @id @default(cuid())
  sessionId      String
  role           String
  content        String
  intent         String?
  sentiment      String?
  confidence     Float?
  productsShown  String      @default("[]")
  productClicked String?
  metadata       String      @default("{}")
  timestamp      DateTime    @default(now())
  session        ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([role, timestamp])
}

model ChatAnalytics {
  id                 String   @id @default(cuid())
  shop               String
  date               DateTime
  totalSessions      Int      @default(0)
  totalMessages      Int      @default(0)
  avgResponseTime    Float    @default(0)
  avgConfidence      Float    @default(0)
  topIntents         String   @default("{}")
  topProducts        String   @default("{}")
  sentimentBreakdown String   @default("{}")
  conversionsTracked Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  workflowUsage      String   @default("{}")

  @@unique([shop, date])
  @@index([shop, date])
  @@index([date])
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model Conversation {
  id        String   @id @default(cuid())
  shop      String
  sessionId String
  message   String
  response  String
  plan      String   @default("BASIC")
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([shop, sessionId])
  @@index([shop, timestamp])
}

model ByokUsage {
  id              String   @id @default(cuid())
  shop            String
  date            DateTime
  totalApiCalls   Int      @default(0)
  totalTokensUsed Int      @default(0)
  promptTokens    Int      @default(0)
  completionTokens Int     @default(0)
  estimatedCost   Float    @default(0)
  plan            String   @default("BYOK")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([shop, date])
  @@index([shop, date])
  @@index([date])
}

enum WorkflowType {
  DEFAULT
  CUSTOM
}
